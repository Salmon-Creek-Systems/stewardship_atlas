<!DOCTYPE html>
<html>
{<head>
    <link rel="stylesheet" href="/local/css/console.css">
</head>
<body>
    <center>
    <table cellpadding=5 valign='top'>
        <tr>
            <td style="width:20%" align="right"><img id="logo" height=100 width=100 /></td>
            <td><h1><span id="swale-name"></span> Fire Atlas <BR>
		<span id="console-type"></span>
    </h1></td>
        </tr>
        <tr valign='top'>
            <td bgcolor="#cccccc">
              <center><h2>MAPS</h2></center>
                <div id="interfaces-section" style="display: none;">
                    <h4>Interfaces</h4>
                    <ul id="interfaces-list"></ul>
                </div>
                <div id="downloads-section" style="display: none;">
                    <h4>Downloads</h4>
                    <ul id="downloads-list"></ul>
 

                </div>
            </td>
            
            


            
            <td ROWSPAN=2 id="layers-section" style="display: none;">
                <center><h2><span id="panel-header">...</span></h2></center>
                <ul id="layers-list"></ul>
		<ul id="usecases-list"></ul>
		
            </td>
        </tr>
        <tr>
            <td>
                <h2>HELP and LINKS</h2>
                <div id="help-section" style="margin: 20px;">
                <ul id="help-list">
                    <li>
                        <a href="/help">About</a>
                    </li>
                    <li>
                        <a href="/help">Help</a>
                    </li>
                    <li>
                        <a href="/staging/outlets/html/internal">Internal</a>
                    </li>		    
                    <li>
                        <a href="/staging/outlets/html/admin">Admin</a>
                    </li>
                    <li>
                        <a href="https://www.google.com/maps/search/volunteer+fire+departments">VFD</a>
                    </li>
                    <li>
                        <a href="/help">Contact</a>
                    </li>

                </ul>    

            </div>
                <h2>VERSIONS</h2>
                (version: <span id="version-string"></span>)
                <div id="versions-section" style="margin: 20px;">
             
                    <button id="publish-button" onclick="startPublish()">Publish Atlas</button>
                    <div id="publish-status" style="margin: 10px 0; padding: 10px; border-radius: 5px; background-color: #f0f0f0; min-height: 20px;"></div>

                
        
                <ul id="versions-list"></ul>    
            </div>
                </td>
         
        </tr>
    
    </table>
    </center>

    <script>
      // Initialize the page with data
      
        function initializePage(data) {
            document.getElementById('logo').src = data.logo;
            document.getElementById('version-string').textContent = data.version_string;
            document.getElementById('swale-name').textContent = data.swaleName;
            document.getElementById('console-type').textContent = data.consoleType;
	    document.getElementById('panel-header').textContent = data.panelHeader;

	    swalename=data.swaleName;
	    
            // Setup interfaces
            if (data.interfaces && data.interfaces.length > 0) {
                const interfacesList = document.getElementById('interfaces-list');
                data.interfaces.forEach(item => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `../../${item.name}/`;
                    a.textContent = item.name;
                    li.appendChild(a);
                    interfacesList.appendChild(li);
                });
                document.getElementById('interfaces-section').style.display = 'block';
            }

            // Setup downloads
            if (data.downloads && data.downloads.length > 0) {
                const downloadsList = document.getElementById('downloads-list');
                data.downloads.forEach(item => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `../${item.name}/`;
                    a.textContent = item.name;
                    li.appendChild(a);
                    downloadsList.appendChild(li);
                });
                document.getElementById('downloads-section').style.display = 'block';
            }

            // Setup versions
            if (data.versions && data.versions.length > 0) {
                const versionsList = document.getElementById('versions-list');
                data.versions.forEach(item => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `../../${item}/html/admin.html`;
                    a.textContent = item;
                    li.appendChild(a);
                    versionsList.appendChild(li);
                });
                document.getElementById('versions-section').style.display = 'block';
            }

            // Setup use cases
            if (data.useCases && data.useCases.length > 0) {
                const useCasesList = document.getElementById('usecases-list');
                data.useCases.forEach(usr => {
                    const li = document.createElement('li');

                    li.textContent = usr.name;
		    const casesList = document.createElement('ul');
		    usr.cases.forEach(ucase => {
			const icli = document.createElement('li');
			const ica = document.createElement('a');
			ica.href = ucase.uri;
			ica.textContent = ucase.name;
			icli.appendChild(ica);
			casesList.appendChild(icli);
			
		    });
		    li.appendChild(casesList);
                    useCasesList.appendChild(li);
                });
                document.getElementById('layers-section').style.display = 'block';
            }



            // Setup layers
            if (data.layers && data.layers.length > 0) {
                const layersList = document.getElementById('layers-list');

                data.layers.forEach(item => {
		    // Link to outlet directory
		    const li = document.createElement('li');
                    const a1 = document.createElement('a');
                    a1.href = `../../../layers/${item.name}/`;
                    a1.textContent = item.name;
                    li.appendChild(a1);

		    // Link to web edit for layer
                    const a2 = document.createElement('a');
                    a2.href = `../../webedit/${item.name}_create.html`;
                    a2.textContent = ' (draw) ';
                    li.appendChild(document.createTextNode(' '));
                    li.appendChild(a2);


		    // Link to web anno for layer
                    const al = document.createElement('a');
                    al.href = `../../webedit/${item.name}_annotate.html`;
                    al.textContent = ' (annotate) ';
                    li.appendChild(document.createTextNode(' '));
                    li.appendChild(al);


		    
		    // Link to metadata file
                    const a3 = document.createElement('a');
                    a3.href = `${item.name}/attribution.html`;
                    a3.textContent = ' (source) ';
                    li.appendChild(document.createTextNode(' '));
                    li.appendChild(a3);

		    

		    //if (item.name in data.spreadsheets) {
		    // Link to gheet export
		    const a4 = document.createElement('a');
		    a4.href = `https://internal.fireatlas.org:9998/export_gsheet/${swalename}/${item.name}`;
		    a4.textContent = ' (export sheet) ';
		    li.appendChild(document.createTextNode(' '));
		    li.appendChild(a4);       
		    
		    // Link to gheet import
		    const a5 = document.createElement('a');
		    a5.href = data.spreadsheets[item.name];
		    a5.textContent = ' (import sheet) ';
		    li.appendChild(document.createTextNode(' '));
		    li.appendChild(a5);       
		    //};
            // Link to delta upload
            const a6 = document.createElement('a');
            a6.href = '#';
            a6.textContent = ' (upload) ';
            a6.onclick = function(e) {
                e.preventDefault();
                
                // Create a file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.geojson,application/json';
                
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const geojson = JSON.parse(e.target.result);
                            
                            // Add layer name to the GeoJSON
                            geojson.layer = item.name;
                            geojson.action = 'add'; // or whatever default action you want
                            
                            // Send to server using the same API as upload button
                            var xmlhttp = new XMLHttpRequest();
                            xmlhttp.open("POST", `http://fireatlas.org:9998/delta_upload/${swalename}/${item.name}`);
                            xmlhttp.setRequestHeader("Content-Type", "application/json");
                            var geojson_data = JSON.stringify({"data": geojson});
                            xmlhttp.send(geojson_data);
                            
                            xmlhttp.onreadystatechange = function() {
                                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                                    alert('Upload successful!');
                                } else if (xmlhttp.readyState == 4 && xmlhttp.status !== 200) {
                                    alert('Error uploading file: ' + (xmlhttp.responseText || 'Unknown error'));
                                }
                            }
                        } catch (error) {
                            alert('Error reading file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };
                
                fileInput.click();
            };
            li.appendChild(document.createTextNode(' '));
            li.appendChild(a6);

		    // Link to refresh/materialize
                    const refreshLink = document.createElement('a');
                    refreshLink.href = '#';
                    refreshLink.textContent = ' (refresh) ';
                    refreshLink.onclick = function(e) {
                        e.preventDefault();
                        fetch(`http://fireatlas.org:9998/refresh?swale=scvfd&asset=${item.name}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Refresh successful!');
                                    window.location.reload();  // Reload the current page
                                } else {
                                    alert('Refresh failed: ' + data.message);
                                }
                            })
                            .catch(error => {
                                alert('Error during refresh: ' + error);
                            });
                    };
                    li.appendChild(document.createTextNode(' '));
                    //li.appendChild(refreshLink);

                    layersList.appendChild(li);
                });
                document.getElementById('layers-section').style.display = 'block';
            }
        }

        function startPublish() {
            const statusDiv = document.getElementById('publish-status');
            const publishButton = document.getElementById('publish-button');
            
            // Disable button during processing
            publishButton.disabled = true;
            statusDiv.innerHTML = `Processing... ${swalename}`;
            
            fetch(`https://internal.fireatlas.org:9998/publish?swale=${swalename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.publishing) {
                        // Start polling for completion
                        statusDiv.innerHTML = 'Publishing in progress...';
                        pollPublishStatus();
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = 'Error: ' + error;
                    publishButton.disabled = false;
                });
        }
        
        function pollPublishStatus() {
            const statusDiv = document.getElementById('publish-status');
            const publishButton = document.getElementById('publish-button');
            
            fetch(`https://internal.fireatlas.org:9998/publish-status?swale=${swalename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.publishing) {
                        // Still publishing, check again in 5 seconds
			statusDiv.innerHTML = 'Publishing in progress...<HR>' + data.log.join("<BR>\n");
                        setTimeout(pollPublishStatus, 5000);
                    } else {
                        // Publishing complete
                        statusDiv.innerHTML = 'Publishing complete!';
                        publishButton.disabled = false;
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = 'Error: ' + error;
                    publishButton.disabled = false;
                });
        }
    </script>
</body>
</html> 
