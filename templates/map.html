<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{title}</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <link href='css/map.css' rel='stylesheet' />
    <link href='css/edit_controls.css' rel='stylesheet' />
    <link href='https://www.unpkg.com/@watergis/maplibre-gl-legend@latest/dist/maplibre-gl-legend.css' rel='stylesheet' />
    <script src="https://www.unpkg.com/@watergis/maplibre-gl-legend@latest/dist/maplibre-gl-legend.umd.js"></script>
    <style>
        .help-popup {{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }}
        
        .help-content {{
            background: white;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }}
        
        .help-header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid #eee;
        }}
        
        .help-header h2 {{
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }}
        
        .close-button {{
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }}
        
        .close-button:hover {{
            color: #333;
        }}
        
        .help-body {{
            padding: 20px;
        }}
        
        .help-body ul {{
            margin: 0;
            padding-left: 20px;
        }}
        
        .help-body li {{
            margin-bottom: 10px;
            line-height: 1.4;
            color: #555;
        }}
        
        #help-link {{
            font-weight: bold;
            font-size: 1.2em;
            text-decoration: none;
            color: #007bff;
        }}
        
        #help-link:hover {{
            color: #0056b3;
        }}
    </style>
</head>
<body>
    <div id="controls">
        <div class="input-group">
            <label>Basemap:</label><br/>
            <select id="basemap-select" class="input-field">
                <option value="basemap">LIDAR Hillshade</option>
                <option value="satellite">Satellite (ESRI)</option>
                <option value="usgs">USGS Topo</option>
                <option value="terrain">OpenMapTiles Terrain</option>
            </select>
        </div>
        <div class="input-group">
            <label>Location sharing format:</label><br/>
            <select id="coords-format-select" class="input-field">
                <option value="json">JSON coordinates</option>
                <option value="google">Google Maps link</option>
                <option value="internal">Internal map link</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="location-input" class="input-field" placeholder="paste location here" style="width: calc(100% - 50px); display: inline-block;">
            <button id="go-location-btn" class="button" style="width: 40px; margin-left: 5px; padding: 5px;">Go</button>
        </div>
        <div class="button-group">
            <a href="../html/admin" class="button link-button">Home</a>
            <a href="#" class="button link-button" id="help-link">?</a>
        </div>
        <div id="loading-progress" class="progress-bar">
            <div class="progress-fill"></div>
            <div class="progress-text">Loading layers...</div>
        </div>
    </div>
    <div id="map"></div>
    
    <!-- Help popup -->
    <div id="help-popup" class="help-popup" style="display: none;">
        <div class="help-content">
            <div class="help-header">
                <h2>Interactive Web Map Help</h2>
                <button id="close-help" class="close-button">&times;</button>
            </div>
            <div class="help-body">
                <ul>
                    <li>click/drag to move map</li>
                    <li>scroll to zoom</li>
                    <li>alt+click (desktop) or long press (mobile) to copy location</li>
                    <li>control layer visibility in legend box</li>
                    <li>select basemap with dropdown</li>
                </ul>
            </div>
        </div>
    </div>
    <script type="module">
      // maplibre-gl is already loaded globally via script tag, no import needed

  
      const SATELLITE_SOURCE = {{
            'type': 'raster',
            'tiles': [
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{{z}}/{{y}}/{{x}}'
            ],
            'tileSize': 256,
            'attribution': 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      }};
      const USGS_SOURCE = {{
            'type': 'raster',
            'tiles': [
                'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{{z}}/{{y}}/{{x}}'
            ],
            'tileSize': 256,
            'attribution': 'Tiles courtesy of the U.S. Geological Survey'
      }};
      const TERRAIN_SOURCE = {{
            'type': 'raster',
            'tiles': [
                'https://tile.opentopomap.org/{{z}}/{{x}}/{{y}}.png'
            ],
            'tileSize': 256,
            'attribution': 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)'
      }};

      // Initialize the map
      const MAP_CONFIG = {map_config};
      const map = new maplibregl.Map(MAP_CONFIG);
      
      // Function to get URL parameters
      function getUrlParameter(name) {{
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
      }}
      
      // Function to add a marker at specified coordinates
      function addLocationMarker(lat, lng) {{
          // Create a marker element
          const markerEl = document.createElement('div');
          markerEl.className = 'location-marker';
          markerEl.style.cssText = `
              width: 20px;
              height: 20px;
              background-color: #ff0000;
              border: 2px solid #ffffff;
              border-radius: 50%;
              cursor: pointer;
              box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          `;
          
          // Add the marker to the map
          new maplibregl.Marker(markerEl)
              .setLngLat([lng, lat])
              .addTo(map);
      }}
      
      // Check for lat/lng in URL parameters
      const urlLat = getUrlParameter('lat');
      const urlLng = getUrlParameter('lng');
      const urlZoom = getUrlParameter('zoom');
      
      console.log('URL parameters found:', {{ lat: urlLat, lng: urlLng, zoom: urlZoom }});
      
      
      map.addControl(new maplibregl.ScaleControl({{
	  maxWidth: 80,
	  unit: 'metric'
      }}
				     ));
      
    map.addControl(new MaplibreLegendControl.MaplibreLegendControl({{}}, {{reverseOrder: false}}), 'bottom-left');
// Add satellite source and layer
      map.on('load', async () => {{
 
   


    // Get the first layer ID from the style to ensure basemaps are at the bottom
    const style = map.getStyle();
    const firstLayerId = style.layers[0].id;

    // Handle URL parameters after map is loaded
    if (urlLat && urlLng) {{
        const lat = parseFloat(urlLat);
        const lng = parseFloat(urlLng);
        const zoom = urlZoom ? parseFloat(urlZoom) : 14; // Default zoom if not specified
        
        console.log('Processing URL parameters:', {{ lat, lng, zoom }});
        
        // Validate coordinates
        if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {{
            // Validate zoom level (0-22)
            const validZoom = !isNaN(zoom) && zoom >= 0 && zoom <= 22 ? zoom : 14;
            
            console.log('Valid coordinates, centering map...');
            
            // Center map on the specified location
            map.setCenter([lng, lat]);
            map.setZoom(validZoom); // Use the specified or validated zoom level
            
            // Add a marker at the location
            addLocationMarker(lat, lng);
            
            console.log(`Map centered at: ${{lat}}, ${{lng}} with zoom: ${{validZoom}}`);
        }} else {{
            console.warn('Invalid coordinates in URL parameters');
        }}
    }}

    // Initialize progress tracking
    const progressBar = document.getElementById('loading-progress');
    const progressFill = progressBar.querySelector('.progress-fill');
    const progressText = progressBar.querySelector('.progress-text');
    let loadedLayers = 0;
    const totalLayers = 4; // basemap + 3 basemaps

    // Update progress
	  const updateProgress = () => {{
              loadedLayers++;
        const percent = (loadedLayers / totalLayers) * 100;
        progressFill.style.width = `${{percent}}%`;
        progressText.textContent = `Loading layers... ${{Math.round(percent)}}%`;
        
              if (loadedLayers === totalLayers) {{
		  setTimeout(() => {{
                      progressBar.style.display = 'none';
		  }}, 500);
              }}
	  }};

    // Track layer loading
	  map.on('sourcedata', (e) => {{
              if (e.isSourceLoaded) {{
		  updateProgress();
              }}
	  }});

	  map.addSource('satellite', SATELLITE_SOURCE);
	  map.addSource('usgs', USGS_SOURCE);
	  map.addSource('terrain', TERRAIN_SOURCE);
	  
    // Add satellite layer before the first existing layer
    map.addLayer({{
        'id': 'satellite-layer',
        'type': 'raster',
        'source': 'satellite',
        'paint': {{
            'raster-opacity': 0.7
        }}
    }}, firstLayerId);
    
    // Add USGS layer before the first existing layer
    map.addLayer({{
        'id': 'usgs-layer',
        'type': 'raster',
        'source': 'usgs',
        'paint': {{
            'raster-opacity': 0.7
        }}
    }}, firstLayerId);
    
    // Add terrain layer before the first existing layer
    map.addLayer({{
        'id': 'terrain-layer',
        'type': 'raster',
        'source': 'terrain',
        'paint': {{
            'raster-opacity': 0.7
        }}
    }}, firstLayerId);
    
    // Add event listener for basemap selection
    document.getElementById('basemap-select').addEventListener('change', (event) => {{
        const selectedBasemap = event.target.value;
        
        // Hide all basemap layers first
        const layers = map.getStyle().layers;
        for (const layer of layers) {{
            if (layer.id === 'basemap-layer' || 
                layer.id === 'satellite-layer' || 
                layer.id === 'usgs-layer' || 
                layer.id === 'terrain-layer') {{
                map.setLayoutProperty(layer.id, 'visibility', 'none');
            }}
				    }}
										     
        
        // Show the selected basemap
	switch (selectedBasemap) {{
            case 'basemap':
                // The default basemap is already in the style, just make it visible
                map.setLayoutProperty('basemap-layer', 'visibility', 'visible');
                break;
            case 'satellite':
                map.setLayoutProperty('satellite-layer', 'visibility', 'visible');
                break;
            case 'usgs':
                map.setLayoutProperty('usgs-layer', 'visibility', 'visible');
                break;
            case 'terrain':
                map.setLayoutProperty('terrain-layer', 'visibility', 'visible');
                break;
        }}
    }});

    // Set initial visibility - hide all basemaps except the default one
    map.setLayoutProperty('satellite-layer', 'visibility', 'none');
    map.setLayoutProperty('usgs-layer', 'visibility', 'none');
    map.setLayoutProperty('terrain-layer', 'visibility', 'none');
    // The default basemap should already be visible from the style
    // layers we need to load dynamically follow:
    {dynamic_layers}

    // Add Alt+Click and long press handler to copy coordinates to clipboard
    let longPressTimer = null;
    let longPressDelay = 500; // 500ms for long press
    let longPressStartPos = null;
    let longPressMoveThreshold = 10; // pixels of movement to cancel long press
    
    // Function to handle location sharing
    function handleLocationShare(lngLat) {{
        console.log('Location sharing triggered at:', lngLat);
        
        const coords = {{
            latitude: lngLat.lat,
            longitude: lngLat.lng
        }};
        
        const format = document.getElementById('coords-format-select').value;
        let textToCopy;

        if (format === 'json') {{
            textToCopy = JSON.stringify(coords, null, 2);
        }} else if (format === 'google') {{ // Google Maps link
            textToCopy = `https://www.google.com/maps/@${{lngLat.lat}},${{lngLat.lng}},15z`;
        }} else if (format === 'internal') {{ // Internal map link
            textToCopy = `https://${{window.location.hostname}}${{window.location.pathname}}?lat=${{lngLat.lat}}&lng=${{lngLat.lng}}&zoom=${{map.getZoom()}}`;
        }}
        
        console.log('Text to copy:', textToCopy);
        
        // Try to copy to clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {{
            navigator.clipboard.writeText(textToCopy).then(() => {{
                console.log('Successfully copied to clipboard');
                // Show a brief notification
                const notification = document.createElement('div');
                notification.textContent = 'Location copied to clipboard!';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    z-index: 1000;
                    font-family: Arial, sans-serif;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                `;
                document.body.appendChild(notification);
                
                // Remove notification after 2 seconds
                setTimeout(() => {{
                    notification.remove();
                }}, 2000);
            }}).catch(err => {{
                console.error('Failed to copy coordinates:', err);
                // Fallback: show the text in an alert
                alert(`Location: ${{textToCopy}}`);
            }});
        }} else {{
            // Fallback for browsers that don't support clipboard API
            console.log('Clipboard API not supported, showing alert');
            alert(`Location: ${{textToCopy}}`);
        }}
    }}
    
    // Function to clear long press timer and reset position
    function clearLongPressTimer() {{
        if (longPressTimer) {{
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }}
        longPressStartPos = null;
    }}
    
    // Function to check if movement exceeds threshold
    function hasMovedTooMuch(currentPos) {{
        if (!longPressStartPos) return false;
        const dx = currentPos.x - longPressStartPos.x;
        const dy = currentPos.y - longPressStartPos.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        return distance > longPressMoveThreshold;
    }}
    
    // Alt+Click handler (desktop)
    map.on('click', (e) => {{
        console.log('Map click event fired', {{
            ctrlKey: e.originalEvent.ctrlKey,
            metaKey: e.originalEvent.metaKey,
            shiftKey: e.originalEvent.shiftKey,
            altKey: e.originalEvent.altKey,
            type: e.originalEvent.type,
            target: e.originalEvent.target.tagName
        }});
        
        // Check if meta key is pressed (Alt+Click)
        if (e.originalEvent.metaKey) {{
            console.log('Alt key pressed, processing click');
            handleLocationShare(e.lngLat);
        }} else {{
            console.log('Alt key not pressed, ignoring click');
        }}
    }});
    
    // Long press handlers (mobile)
    map.on('mousedown', (e) => {{
        // Store the starting position
        longPressStartPos = {{ x: e.originalEvent.clientX, y: e.originalEvent.clientY }};
        
        // Start long press timer
        longPressTimer = setTimeout(() => {{
            // Check if we've moved too much before triggering
            if (!hasMovedTooMuch({{ x: e.originalEvent.clientX, y: e.originalEvent.clientY }})) {{
                console.log('Long press detected');
                handleLocationShare(e.lngLat);
            }} else {{
                console.log('Long press cancelled due to movement');
            }}
            clearLongPressTimer();
        }}, longPressDelay);
    }});
    
    map.on('mousemove', (e) => {{
        // Cancel long press if mouse moves too much
        if (longPressTimer && hasMovedTooMuch({{ x: e.originalEvent.clientX, y: e.originalEvent.clientY }})) {{
            console.log('Long press cancelled due to movement');
            clearLongPressTimer();
        }}
    }});
    
    map.on('mouseup', (e) => {{
        // Clear long press timer on mouse up
        clearLongPressTimer();
    }});
    
    map.on('mouseleave', (e) => {{
        // Clear long press timer when mouse leaves map
        clearLongPressTimer();
    }});
    
    // Touch events for mobile devices
    map.on('touchstart', (e) => {{
        // Store the starting position
        if (e.originalEvent.touches && e.originalEvent.touches[0]) {{
            longPressStartPos = {{ x: e.originalEvent.touches[0].clientX, y: e.originalEvent.touches[0].clientY }};
        }}
        
        // Start long press timer for touch
        longPressTimer = setTimeout(() => {{
            // Check if we've moved too much before triggering
            if (e.originalEvent.touches && e.originalEvent.touches[0] && 
                !hasMovedTooMuch({{ x: e.originalEvent.touches[0].clientX, y: e.originalEvent.touches[0].clientY }})) {{
                console.log('Touch long press detected');
                handleLocationShare(e.lngLat);
            }} else {{
                console.log('Touch long press cancelled due to movement');
            }}
            clearLongPressTimer();
        }}, longPressDelay);
    }});
    
    map.on('touchmove', (e) => {{
        // Cancel long press if touch moves too much
        if (longPressTimer && e.originalEvent.touches && e.originalEvent.touches[0] && 
            hasMovedTooMuch({{ x: e.originalEvent.touches[0].clientX, y: e.originalEvent.touches[0].clientY }})) {{
            console.log('Touch long press cancelled due to movement');
            clearLongPressTimer();
        }}
    }});
    
    map.on('touchend', (e) => {{
        // Clear long press timer on touch end
        clearLongPressTimer();
    }});
    
    // Add a global click listener to see if alt-clicks are being captured elsewhere
    document.addEventListener('click', (e) => {{
        if (e.metaKey) {{
            console.log('Global click listener detected alt-click on:', e.target.tagName, e.target.className);
        }}
    }});
    
    // Function to parse degrees format coordinates
    function parseDegreesFormat(input) {{
        console.log('Parsing input:', input);
        
        // Try to parse degrees format: "40°14′18″ N  123°57′39″ W"
        const degreesPattern = /(\d+)°(\d+)′(\d+)″\s*([NS])\s*(\d+)°(\d+)′(\d+)″\s*([EW])/;
        const match = input.trim().match(degreesPattern);
        
        if (match) {{
            const [, latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir] = match;
            
            // Convert to decimal degrees
            let lat = parseInt(latDeg) + parseInt(latMin) / 60 + parseInt(latSec) / 3600;
            let lng = parseInt(lngDeg) + parseInt(lngMin) / 60 + parseInt(lngSec) / 3600;
            
            // Apply direction
            if (latDir === 'S') lat = -lat;
            if (lngDir === 'W') lng = -lng;
            
            console.log('Parsed degrees format:', {{ lat, lng }});
            return {{ lat, lng }};
        }}
        
        // Try to parse JSON format
        try {{
            const jsonCoords = JSON.parse(input.trim());
            if (jsonCoords.latitude && jsonCoords.longitude) {{
                console.log('Parsed JSON format:', jsonCoords);
                return {{ lat: jsonCoords.latitude, lng: jsonCoords.longitude }};
            }}
        }} catch (e) {{
            console.log('Not JSON format');
        }}
        
        // Try to parse Google Maps link
        const googlePattern = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
        const googleMatch = input.trim().match(googlePattern);
        if (googleMatch) {{
            const [, lat, lng] = googleMatch;
            console.log('Parsed Google Maps format:', {{ lat: parseFloat(lat), lng: parseFloat(lng) }});
            return {{ lat: parseFloat(lat), lng: parseFloat(lng) }};
        }}
        
        // Try to parse plain comma-separated coordinates
        const commaPattern = /(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/;
        const commaMatch = input.trim().match(commaPattern);
        if (commaMatch) {{
            const [, lat, lng] = commaMatch;
            console.log('Parsed comma format:', {{ lat: parseFloat(lat), lng: parseFloat(lng) }});
            return {{ lat: parseFloat(lat), lng: parseFloat(lng) }};
        }}
        
        return null;
    }}
    
    // Function to show error popup
    function showErrorPopup(message) {{
        const popup = document.createElement('div');
        popup.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 2000;
            font-family: Arial, sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 400px;
            text-align: center;
        `;
        popup.innerHTML = `
            <h3>Cannot Parse Location</h3>
            <p>${{message}}</p>
            <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 15px; border: none; border-radius: 4px; cursor: pointer;">OK</button>
        `;
        document.body.appendChild(popup);
    }}
    
    // Function to go to location
    function goToLocation() {{
        const input = document.getElementById('location-input').value.trim();
        if (!input) {{
            showErrorPopup('Please enter a location to go to.');
            return;
        }}
        
        const coords = parseDegreesFormat(input);
        if (!coords) {{
            showErrorPopup(`Cannot parse location: "${{input}}"<br><br>Supported formats:<br>• Degrees: 40°14′18″ N 123°57′39″ W<br>• JSON: {{"latitude": 37.7749, "longitude": -122.4194}}<br>• Google Maps: https://maps.google.com/...<br>• Plain: 37.7749, -122.4194`);
            return;
        }}
        
        // Validate coordinates
        if (coords.lat < -90 || coords.lat > 90 || coords.lng < -180 || coords.lng > 180) {{
            showErrorPopup(`Invalid coordinates: ${{coords.lat}}, ${{coords.lng}}<br><br>Latitude must be between -90 and 90<br>Longitude must be between -180 and 180`);
            return;
        }}
        
        // Redirect to internal map
        const url = `https://${{window.location.hostname}}${{window.location.pathname}}?lat=${{coords.lat}}&lng=${{coords.lng}}`;
        console.log('Redirecting to:', url);
        window.location.href = url;
    }}
    
    // Add event listeners for the Go button and Enter key
    const goBtn = document.getElementById('go-location-btn');
    const locationInput = document.getElementById('location-input');
    
    if (goBtn) {{
        goBtn.addEventListener('click', goToLocation);
    }}
    
    if (locationInput) {{
        locationInput.addEventListener('keypress', (e) => {{
            if (e.key === 'Enter') {{
                goToLocation();
            }}
        }});
    }}

    // Help popup functionality
    document.getElementById('help-link').addEventListener('click', (e) => {{
        e.preventDefault();
        document.getElementById('help-popup').style.display = 'flex';
    }});

    document.getElementById('close-help').addEventListener('click', () => {{
        document.getElementById('help-popup').style.display = 'none';
    }});

    // Close popup when clicking outside
    document.getElementById('help-popup').addEventListener('click', (e) => {{
        if (e.target.id === 'help-popup') {{
            document.getElementById('help-popup').style.display = 'none';
        }}
    }});

    // Close popup with Escape key
    document.addEventListener('keydown', (e) => {{
        if (e.key === 'Escape') {{
            document.getElementById('help-popup').style.display = 'none';
        }}
    }});

}}); 



</script>
</body>
</html> 
