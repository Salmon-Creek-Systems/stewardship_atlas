<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{title}</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <link href='css/map.css' rel='stylesheet' />
    <link href='css/edit_controls.css' rel='stylesheet' />
    <link href='https://www.unpkg.com/@watergis/maplibre-gl-legend@latest/dist/maplibre-gl-legend.css' rel='stylesheet' />
    <script src="https://www.unpkg.com/@watergis/maplibre-gl-legend@latest/dist/maplibre-gl-legend.umd.js"></script>
</head>
<body>
    <div id="controls">
        <div class="input-group">
            <label>Basemap:</label><br/>
            <select id="basemap-select" class="input-field">
                <option value="basemap">LIDAR Hillshade</option>
                <option value="satellite">Satellite (ESRI)</option>
                <option value="usgs">USGS Topo</option>
                <option value="terrain">OpenMapTiles Terrain</option>
            </select>
            <div id="loading-progress" class="progress-bar">
                <div class="progress-fill"></div>
                <div class="progress-text">Loading layers...</div>
            </div>
        </div>
        <div class="button-group">
            <a href="../html/admin.html" class="button link-button">Home</a>
        </div>
    </div>
    <div id="map"></div>
    <script type="module">
      // maplibre-gl is already loaded globally via script tag, no import needed
    //import { MaplibreLegendControl } from "@watergis/maplibre-gl-legend";
    //import '@watergis/maplibre-gl-legend/dist/maplibre-gl-legend.css';
  
      const SATELLITE_SOURCE = {{
            'type': 'raster',
            'tiles': [
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{{z}}/{{y}}/{{x}}'
            ],
            'tileSize': 256,
            'attribution': 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      }};
      const USGS_SOURCE = {{
            'type': 'raster',
            'tiles': [
                'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{{z}}/{{y}}/{{x}}'
            ],
            'tileSize': 256,
            'attribution': 'Tiles courtesy of the U.S. Geological Survey'
      }};
      const TERRAIN_SOURCE = {{
            'type': 'raster',
            'tiles': [
                'https://tile.opentopomap.org/{{z}}/{{x}}/{{y}}.png'
            ],
            'tileSize': 256,
            'attribution': 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)'
      }};

      // Initialize the map
      const MAP_CONFIG = {map_config};
      const map = new maplibregl.Map(MAP_CONFIG);
      
      
      map.addControl(new maplibregl.ScaleControl({{
	  maxWidth: 80,
	  unit: 'metric'
      }}
				     ));
      
    map.addControl(new MaplibreLegendControl({}, {reverseOrder: false}), 'bottom-left');
// Add satellite source and layer
      map.on('load', async () => {{
 
   


    // Get the first layer ID from the style to ensure basemaps are at the bottom
    const style = map.getStyle();
    const firstLayerId = style.layers[0].id;

    // Initialize progress tracking
    const progressBar = document.getElementById('loading-progress');
    const progressFill = progressBar.querySelector('.progress-fill');
    const progressText = progressBar.querySelector('.progress-text');
    let loadedLayers = 0;
    const totalLayers = 4; // basemap + 3 basemaps

    // Update progress
	  const updateProgress = () => {{
              loadedLayers++;
        const percent = (loadedLayers / totalLayers) * 100;
        progressFill.style.width = `${{percent}}%`;
        progressText.textContent = `Loading layers... ${{Math.round(percent)}}%`;
        
              if (loadedLayers === totalLayers) {{
		  setTimeout(() => {{
                      progressBar.style.display = 'none';
		  }}, 500);
              }}
	  }};

    // Track layer loading
	  map.on('sourcedata', (e) => {{
              if (e.isSourceLoaded) {{
		  updateProgress();
              }}
	  }});

	  map.addSource('satellite', SATELLITE_SOURCE);
	  map.addSource('usgs', USGS_SOURCE);
	  map.addSource('terrain', TERRAIN_SOURCE);
	  
    // Add satellite layer before the first existing layer
    map.addLayer({{
        'id': 'satellite-layer',
        'type': 'raster',
        'source': 'satellite',
        'paint': {{
            'raster-opacity': 0.7
        }}
    }}, firstLayerId);
    
    // Add USGS layer before the first existing layer
    map.addLayer({{
        'id': 'usgs-layer',
        'type': 'raster',
        'source': 'usgs',
        'paint': {{
            'raster-opacity': 0.7
        }}
    }}, firstLayerId);
    
    // Add terrain layer before the first existing layer
    map.addLayer({{
        'id': 'terrain-layer',
        'type': 'raster',
        'source': 'terrain',
        'paint': {{
            'raster-opacity': 0.7
        }}
    }}, firstLayerId);
    
    // Add event listener for basemap selection
    document.getElementById('basemap-select').addEventListener('change', (event) => {{
        const selectedBasemap = event.target.value;
        
        // Hide all basemap layers first
        const layers = map.getStyle().layers;
        for (const layer of layers) {{
            if (layer.id === 'basemap-layer' || 
                layer.id === 'satellite-layer' || 
                layer.id === 'usgs-layer' || 
                layer.id === 'terrain-layer') {{
                map.setLayoutProperty(layer.id, 'visibility', 'none');
            }}
				    }}
										     
        
        // Show the selected basemap
	switch (selectedBasemap) {{
            case 'basemap':
                // The default basemap is already in the style, just make it visible
                map.setLayoutProperty('basemap-layer', 'visibility', 'visible');
                break;
            case 'satellite':
                map.setLayoutProperty('satellite-layer', 'visibility', 'visible');
                break;
            case 'usgs':
                map.setLayoutProperty('usgs-layer', 'visibility', 'visible');
                break;
            case 'terrain':
                map.setLayoutProperty('terrain-layer', 'visibility', 'visible');
                break;
        }}
    }});

    // Set initial visibility - hide all basemaps except the default one
    map.setLayoutProperty('satellite-layer', 'visibility', 'none');
    map.setLayoutProperty('usgs-layer', 'visibility', 'none');
    map.setLayoutProperty('terrain-layer', 'visibility', 'none');
    // The default basemap should already be visible from the style
    // layers we need to load dynamically follow:
    {dynamic_layers}


}}); 



</script>
</body>
</html> 
