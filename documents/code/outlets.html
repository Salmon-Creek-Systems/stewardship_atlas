<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>outlets.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>outlets.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">time</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">duckdb</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">nbformat</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">versioning</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">geojson</span>
<span class="kn">import</span> <span class="nn">gspread</span>

<span class="kn">import</span> <span class="nn">dataswale_geojson</span>
<span class="kn">import</span> <span class="nn">utils</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Configure logging</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Generate a JSON object for a web map in MapLibre.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">webmap_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sprite_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>We will set up sources and layers as static content loaded initially in HTML where possible.
Layers which invole dynamic content - marker images for example - will be added seperately 
since the layer must be set up inside the callback for the image load.</p>
<p>Calculate center and zoom from bbox</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">bbox</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
    <span class="n">center_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> 
    <span class="n">lat_diff</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">]</span>
    <span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># Default zoom, could be calculated based on bbox size</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Set up the map config general properties</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">atlas_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/staging&quot;</span>
    <span class="n">sprite_url</span> <span class="o">=</span> <span class="n">atlas_url</span> <span class="o">+</span> <span class="s2">&quot;/outlets/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/sprite&quot;</span>
    <span class="n">map_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;glyphs&quot;</span> <span class="p">:</span> <span class="s2">&quot;https://fonts.undpgeohub.org/fonts/</span><span class="si">{fontstack}</span><span class="s2">/</span><span class="si">{range}</span><span class="s2">.pbf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">center_lon</span><span class="p">,</span> <span class="n">center_lat</span><span class="p">],</span>
            <span class="s2">&quot;zoom&quot;</span><span class="p">:</span> <span class="n">zoom</span>
            <span class="p">}</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Add sprite if available</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">sprite_json</span><span class="p">:</span>
        <span class="n">map_config</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">][</span><span class="s1">&#39;sprite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprite_url</span>
    
    <span class="n">map_sources</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">map_layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dynamic_layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
    <span class="n">layers_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]}</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In webedit, got Outlet Conf: </span><span class="si">{</span><span class="n">outlet_config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>for each layer used in outlet, we add a source and display layer, and possibly a label layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">outlet_config</span><span class="p">[</span><span class="s1">&#39;in_layers&#39;</span><span class="p">]:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">layers_dict</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;raster&#39;</span><span class="p">:</span>
            <span class="n">map_sources</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;../../layers/</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">.tiff.jpg&quot;</span><span class="p">,</span>
                <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">bbox_to_corners</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">])}</span>
        <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;documents&#39;</span><span class="p">:</span>
            <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>map_sources[layer_name] =  {
   &lsquo;type&rsquo;: &lsquo;image&rsquo;, 
   &lsquo;url&rsquo;: f&rdquo;../../layers/{layer_name}/{layer_name}.tiff.jpg&rdquo;,
   &lsquo;coordinates&rsquo;: utils.bbox_to_corners(config[&lsquo;dataswale&rsquo;][&lsquo;bbox&rsquo;])}</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_sources</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;../../layers/</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">.geojson&quot;</span>
            <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Add Display Layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">map_layer</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">-layer&quot;</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">layer_name</span>
                <span class="p">}</span>
        <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;raster&#39;</span><span class="p">:</span>            
            <span class="n">map_layer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;raster&#39;</span><span class="p">,</span>
                <span class="s1">&#39;paint&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;raster-opacity&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">&quot;raster-contrast&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}})</span>
                              
        <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;polygon&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>map_layer[&lsquo;paint&rsquo;] = {</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">map_layer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;fill&#39;</span><span class="p">,</span>
                <span class="s1">&#39;symbol_placement&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
                <span class="s1">&#39;text_offset&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;paint&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;fill-opacity&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_opacity&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="s2">&quot;fill-color&quot;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">rgb_to_css</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">])),</span>
                    <span class="s2">&quot;fill-outline-color&quot;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">rgb_to_css</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">]))}</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linestring&#39;</span><span class="p">:</span>
            <span class="n">map_layer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                <span class="s1">&#39;symbol_placement&#39;</span><span class="p">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                <span class="s1">&#39;paint&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;line-color&quot;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">rgb_to_css</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">])),</span>
                    <span class="s2">&quot;line-width&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;vector_width&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="p">})</span>
        <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
            <span class="n">map_layer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;circle&#39;</span><span class="p">,</span>
                <span class="s1">&#39;symbol_placement&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
                <span class="s2">&quot;icon-color&quot;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">rgb_to_css</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">])),</span>
                <span class="s2">&quot;icon-size&quot;</span><span class="p">:</span> <span class="mi">20</span>
                
            <span class="p">})</span>
        


        <span class="k">if</span> <span class="n">vis</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vis&#39;</span><span class="p">):</span>
            <span class="n">map_layer</span> <span class="o">|=</span> <span class="n">vis</span>
        <span class="k">if</span> <span class="n">paint</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paint&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;paint&#39;</span> <span class="ow">in</span> <span class="n">map_layer</span><span class="p">:</span>
                <span class="n">map_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>            
            <span class="n">map_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">]</span> <span class="o">|=</span>  <span class="n">paint</span>
            
                
        <span class="n">map_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_layer</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Maybe add label/icon layer:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_labels&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>            
            <span class="n">label_layer</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">-label-layer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
                <span class="s2">&quot;minzoom&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;maxzoom&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>
                <span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;symbol-placement&quot;</span><span class="p">:</span> <span class="n">map_layer</span><span class="p">[</span><span class="s1">&#39;symbol_placement&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;text-offset&quot;</span><span class="p">:</span> <span class="n">map_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text_offset&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s2">&quot;text-font&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Open Sans Regular&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;text-field&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;text-size&quot;</span><span class="p">:</span> <span class="mi">20</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="k">if</span>  <span class="n">map_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>    
                <span class="n">label_layer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;paint&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;text-halo-width&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s1">&#39;text-halo-blur&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;text-halo-color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF9999&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;text-color&#39;</span><span class="p">:</span> <span class="s1">&#39;#000000&#39;</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="k">elif</span> <span class="n">map_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;fill&quot;</span><span class="p">:</span>
                <span class="n">label_layer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;paint&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;text-color&#39;</span><span class="p">:</span> <span class="s1">&#39;rgb(255,255,255)&#39;</span>
                    <span class="p">}</span>
                <span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>label_layer[&lsquo;paint&rsquo;] |=  layer.get(&lsquo;paint&rsquo;, {})              <br />
XSXSXblabel_layer |=  layer.get(&lsquo;vis&rsquo;, {})</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">vis</span> <span class="o">:=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vis&#39;</span><span class="p">):</span>
                <span class="n">label_layer</span> <span class="o">|=</span> <span class="n">vis</span>
            <span class="k">if</span> <span class="s2">&quot;symbol&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>if paint := layer.get(&lsquo;paint&rsquo;):
   if not &lsquo;paint&rsquo; in label_layer:
       label_layer[&lsquo;paint&rsquo;] = {}          <br />
   label_layer[&lsquo;paint&rsquo;] |=  paint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>label_layer[&lsquo;paint&rsquo;] = layer.get(&lsquo;paint&rsquo;, {})</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">map_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_layer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;icon_if&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;property&#39;</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating a dynamic layer with filter: </span><span class="si">{</span><span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>else:
   logger.info(f&rdquo;Dynamic but no filter: {layer}&rdquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;symbol_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">][</span><span class="s1">&#39;png&#39;</span><span class="p">]</span>
                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon-size&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-anchor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon-anchor&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">)</span>
                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;icon-color&#39;</span> <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">rgb_to_css</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">])),</span>
                    <span class="s1">&#39;text-halo-color&#39;</span><span class="p">:</span> <span class="s1">&#39;rgba(200,200,200,0.5)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;text-halo-width&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;icon-halo-color&#39;</span><span class="p">:</span> <span class="s1">&#39;rgba(255,255,255,0.9)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;icon-halo-blur&#39;</span><span class="p">:</span> <span class="mi">10</span>                    
                <span class="p">}</span>

                <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paint&#39;</span><span class="p">,</span> <span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>If we have sprites, add the layer to the initial style so it appears in legend</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">sprite_json</span> <span class="ow">and</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sprite_json</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Ensure the layer has proper source configuration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="n">layer_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_sources</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Add source for this layer if it doesn&rsquo;t exist</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">map_sources</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;../../layers/</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">.geojson&quot;</span>
                        <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Add metadata for legend display</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">layer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> layer&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;legend&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;symbol&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;icon&#39;</span><span class="p">:</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>  <span class="c1"># This should match the sprite symbol name</span>
                            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                        <span class="p">}</span>
                    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Ensure the layer has proper layout properties for sprite display</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="c1"># Should match sprite symbol name</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon-size&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Increased default size</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-anchor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon-anchor&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">)</span>  <span class="c1"># Position icon below text</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Ensure text and icon are both displayed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;text-allow-overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;icon-allow-overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Position text above icon</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;text-anchor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;text-offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Move text up slightly</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Add icon paint properties to make the symbol visible</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="s1">&#39;paint&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_layer</span><span class="p">:</span>
                        <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">][</span><span class="s1">&#39;icon-color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rgb_to_css</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">]))</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">][</span><span class="s1">&#39;icon-halo-color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rgba(255,255,255,0.9)&#39;</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;paint&#39;</span><span class="p">][</span><span class="s1">&#39;icon-halo-blur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Debug logging for sprite-based label layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding sprite-based label layer: </span><span class="si">{</span><span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with icon-image: </span><span class="si">{</span><span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon-image&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">map_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_layer</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Keep as dynamic layer for loadImage approach</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">dynamic_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_layer</span><span class="p">)</span>
    
    <span class="n">map_config</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">][</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_sources</span>
    <span class="n">map_config</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_layers</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Build legend targets for grouped visibility</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">legend_targets</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Group primary layers with their label layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">map_layers</span><span class="p">:</span>
        <span class="n">layer_id</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Skip label layers - they&rsquo;ll be handled as children</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">layer_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-label-layer&#39;</span><span class="p">):</span>
            <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Check if this layer has a label layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-layer&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">label_layer_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">-label-layer&quot;</span>
        <span class="n">has_label_layer</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">label_layer_id</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">map_layers</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">has_label_layer</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Primary layer with label - create group</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">legend_targets</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>Don&rsquo;t add label layer to legend targets - let the plugin handle it</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Add basic legend properties and group metadata</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;legend&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;symbol&#39;</span>  <span class="c1"># or &#39;line&#39;, &#39;fill&#39; based on layer type</span>
                <span class="p">},</span>
                <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">layer_name</span>  <span class="c1"># Group primary and label layers together</span>
            <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Find and update the label layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">label_layer</span> <span class="ow">in</span> <span class="n">map_layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">label_layer_id</span><span class="p">:</span>
                    <span class="n">label_layer</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;legend&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2"> Labels&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;symbol&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">True</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">layer_name</span>  <span class="c1"># Same group as primary layer</span>
                    <span class="p">}</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Standalone layer - add normally</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">legend_targets</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Add basic legend properties</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;legend&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;symbol&#39;</span>  <span class="c1"># or &#39;line&#39;, &#39;fill&#39; based on layer type</span>
                <span class="p">},</span>
                <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">layer_name</span>  <span class="c1"># Standalone layers get their own group</span>
            <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Log the final map configuration for debugging</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Map style layers: </span><span class="si">{</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no-id&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">map_layers</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dynamic layers: </span><span class="si">{</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no-name&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dynamic_layers</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Legend targets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">legend_targets</span><span class="p">)</span><span class="si">}</span><span class="s2"> layers&quot;</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;map_config&quot;</span><span class="p">:</span> <span class="n">map_config</span><span class="p">,</span> <span class="s2">&quot;dynamic_layers&quot;</span><span class="p">:</span> <span class="n">dynamic_layers</span><span class="p">,</span> <span class="s2">&quot;legend_targets&quot;</span><span class="p">:</span> <span class="n">legend_targets</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Generate the complete HTML page for viewing a map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_map_page</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">map_config_data</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">sprite_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>Read template files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../templates/map.html&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to generate HTML to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Read and convert markdown help content</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="kn">import</span> <span class="nn">markdown</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../documents/webmap_help.md&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">help_markdown</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">help_html</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">help_markdown</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Generate JavaScript for dynamic layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">js_bit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">map_config_data</span><span class="p">[</span><span class="s1">&#39;dynamic_layers&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">sprite_json</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Use sprites for dynamic layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">dynamic_layer</span> <span class="ow">in</span> <span class="n">map_config_data</span><span class="p">[</span><span class="s1">&#39;dynamic_layers&#39;</span><span class="p">]:</span>
                <span class="n">layer_name</span> <span class="o">=</span> <span class="n">dynamic_layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">sprite_json</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Remove the loadImage call and just add the layer directly
The sprite is already loaded in the map style</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">js_bit</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">map.addLayer(</span><span class="si">{layer_json}</span><span class="s2">);</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer_json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dynamic_layer</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Fallback to original loadImage if sprite not found</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">im_uri</span> <span class="o">=</span> <span class="s2">&quot;/local/&quot;</span> <span class="o">+</span> <span class="n">dynamic_layer</span><span class="p">[</span><span class="s1">&#39;symbol_source&#39;</span><span class="p">]</span>
                    <span class="n">im_name</span> <span class="o">=</span> <span class="n">dynamic_layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">layer_json</span> <span class="o">=</span> <span class="n">dynamic_layer</span>
                    <span class="n">js_bit</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">void await map.loadImage(&#39;</span><span class="si">{im_uri}</span><span class="s2">&#39;,</span>
<span class="s2">    (error, image) =&gt; {{</span>
<span class="s2">        if (error) throw error;</span>
<span class="s2">        // Add the image to the map style.                                                              </span>
<span class="s2">        map.addImage(&#39;</span><span class="si">{im_name}</span><span class="s2">&#39;, image);</span>
<span class="s2">        map.addLayer(  </span><span class="si">{layer_json}</span><span class="s2"> );</span>
<span class="s2">        }});</span>

<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Original loadImage approach if no sprites</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">dynamic_layer</span> <span class="ow">in</span> <span class="n">map_config_data</span><span class="p">[</span><span class="s1">&#39;dynamic_layers&#39;</span><span class="p">]:</span>
                <span class="n">im_uri</span> <span class="o">=</span> <span class="s2">&quot;/local/&quot;</span> <span class="o">+</span> <span class="n">dynamic_layer</span><span class="p">[</span><span class="s1">&#39;symbol_source&#39;</span><span class="p">]</span>
                <span class="n">im_name</span> <span class="o">=</span> <span class="n">dynamic_layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">layer_json</span> <span class="o">=</span> <span class="n">dynamic_layer</span>
                <span class="n">js_bit</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">void await map.loadImage(&#39;</span><span class="si">{im_uri}</span><span class="s2">&#39;,</span>
<span class="s2">    (error, image) =&gt; {{</span>
<span class="s2">        if (error) throw error;</span>
<span class="s2">        // Add the image to the map style.                                                              </span>
<span class="s2">        map.addImage(&#39;</span><span class="si">{im_name}</span><span class="s2">&#39;, image);</span>
<span class="s2">        map.addLayer(  </span><span class="si">{layer_json}</span><span class="s2"> );</span>
<span class="s2">        }});</span>

<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    
    <span class="n">processed_template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">map_config</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">map_config_data</span><span class="p">[</span><span class="s1">&#39;map_config&#39;</span><span class="p">],</span>  <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">dynamic_layers</span><span class="o">=</span><span class="n">js_bit</span><span class="p">,</span>
            <span class="n">legend_targets</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">map_config_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;legend_targets&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">webmap_help</span><span class="o">=</span><span class="n">help_html</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
      <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">processed_template</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>Generate a sprite file from PNG images referenced in layers configuration.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_sprite_from_layers</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">webmap_dir</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Args:
    layers_config: List of layer configurations from config[&lsquo;dataswale&rsquo;][&lsquo;layers&rsquo;]
    webmap_dir: Path to the webmap output directory</p>
<p>Returns:
    dict: Mapping of layer names to sprite symbol names, or None if no sprites needed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">layers_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span>
    <span class="n">local_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Find all layers that have PNG symbols</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sprite_layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_config</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_labels&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
            <span class="n">sprite_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sprite_layers</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Collect all unique PNG files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">png_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">sprite_layers</span><span class="p">:</span>
        <span class="n">png_path</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">][</span><span class="s1">&#39;png&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">png_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">png_files</span><span class="p">:</span>
            <span class="n">png_files</span><span class="p">[</span><span class="n">png_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">png_files</span><span class="p">[</span><span class="n">png_path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Create sprite image and JSON</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sprite_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sprite_json_1x</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sprite_json_2x</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Standard sprite dimensions - we&rsquo;ll use 32x32 for each icon (1x) and 64x64 for 2x</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">icon_size_1x</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">icon_size_2x</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">total_width_1x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_width_2x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_height_1x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_height_2x</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>First pass: calculate dimensions and load images</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">png_path</span><span class="p">,</span> <span class="n">layer_names</span> <span class="ow">in</span> <span class="n">png_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Load image from /local/ path (symlink to shared datastore)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">full_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">/</span> <span class="n">png_path</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>Create both 1x and 2x versions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">img_1x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">icon_size_1x</span><span class="p">,</span> <span class="n">icon_size_1x</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
                <span class="n">img_2x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">icon_size_2x</span><span class="p">,</span> <span class="n">icon_size_2x</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
                <span class="n">sprite_images</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_1x</span><span class="p">,</span> <span class="n">img_2x</span><span class="p">,</span> <span class="n">layer_names</span><span class="p">))</span>
                <span class="n">total_width_1x</span> <span class="o">+=</span> <span class="n">icon_size_1x</span> <span class="o">+</span> <span class="n">padding</span>
                <span class="n">total_width_2x</span> <span class="o">+=</span> <span class="n">icon_size_2x</span> <span class="o">+</span> <span class="n">padding</span>
                <span class="n">max_height_1x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_height_1x</span><span class="p">,</span> <span class="n">icon_size_1x</span><span class="p">)</span>
                <span class="n">max_height_2x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_height_2x</span><span class="p">,</span> <span class="n">icon_size_2x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG file not found: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load PNG file </span><span class="si">{</span><span class="n">png_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sprite_images</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Create sprite canvases for both densities</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sprite_canvas_1x</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">total_width_1x</span><span class="p">,</span> <span class="n">max_height_1x</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">sprite_canvas_2x</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">total_width_2x</span><span class="p">,</span> <span class="n">max_height_2x</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Second pass: place images on both canvases and build JSON</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">x_offset_1x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_offset_2x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">img_1x</span><span class="p">,</span> <span class="n">img_2x</span><span class="p">,</span> <span class="n">layer_names</span> <span class="ow">in</span> <span class="n">sprite_images</span><span class="p">:</span>
        <span class="n">sprite_canvas_1x</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">img_1x</span><span class="p">,</span> <span class="p">(</span><span class="n">x_offset_1x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">sprite_canvas_2x</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">img_2x</span><span class="p">,</span> <span class="p">(</span><span class="n">x_offset_2x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Add to sprite JSON for each layer with separate densities</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">:</span>
            <span class="n">sprite_json_1x</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">icon_size_1x</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">icon_size_1x</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_offset_1x</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;pixelRatio&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
            <span class="n">sprite_json_2x</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">icon_size_2x</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">icon_size_2x</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_offset_2x</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;pixelRatio&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
        
        <span class="n">x_offset_1x</span> <span class="o">+=</span> <span class="n">icon_size_1x</span> <span class="o">+</span> <span class="n">padding</span>
        <span class="n">x_offset_2x</span> <span class="o">+=</span> <span class="n">icon_size_2x</span> <span class="o">+</span> <span class="n">padding</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Save sprite files for both densities</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sprite_png_path_1x</span> <span class="o">=</span> <span class="n">webmap_dir</span> <span class="o">/</span> <span class="s2">&quot;sprite.png&quot;</span>
    <span class="n">sprite_png_path_2x</span> <span class="o">=</span> <span class="n">webmap_dir</span> <span class="o">/</span> <span class="s2">&quot;sprite@2x.png&quot;</span>
    <span class="n">sprite_json_path_1x</span> <span class="o">=</span> <span class="n">webmap_dir</span> <span class="o">/</span> <span class="s2">&quot;sprite.json&quot;</span>
    <span class="n">sprite_json_path_2x</span> <span class="o">=</span> <span class="n">webmap_dir</span> <span class="o">/</span> <span class="s2">&quot;sprite@2x.json&quot;</span>
    
    <span class="n">sprite_canvas_1x</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sprite_png_path_1x</span><span class="p">,</span> <span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
    <span class="n">sprite_canvas_2x</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sprite_png_path_2x</span><span class="p">,</span> <span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sprite_json_path_1x</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sprite_json_1x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sprite_json_path_2x</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sprite_json_2x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated sprites with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sprite_images</span><span class="p">)</span><span class="si">}</span><span class="s2"> icons: </span><span class="si">{</span><span class="n">sprite_png_path_1x</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">sprite_png_path_2x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Log the sprite JSON for debugging</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sprite 1x JSON content: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sprite_json_1x</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sprite 2x JSON content: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sprite_json_2x</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">sprite_json_1x</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>Generate an interactive web map using MapLibre GL JS.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_webmap</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>This creates statis HTML and JS files which can be loaded or served directly.</p>
<p>map.html is where we insert a JSON doc with all the layer information.
map.js is used to do dynamic map processing. 
For example, we seem to have to load images used for markers in the map there after the map HTML is fully loaded.</p>
<p>So let&rsquo;s consider doing it all dynamically in the JS.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>Generate sprite file first if needed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">webmap_dir</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">name</span>
    <span class="n">webmap_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sprite_json</span> <span class="o">=</span> <span class="n">generate_sprite_from_layers</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">webmap_dir</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Generate base map configuration with sprite</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">map_config</span> <span class="o">=</span> <span class="n">webmap_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sprite_json</span><span class="p">)</span>
    
    <span class="n">basemap_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;in_layers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">basemap_dir</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">basemap_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>make a JPG of basemap tiff..
TODO this should be a tiling URL instead of a local file..
TODO maybe resampling happens here?
TODO here is where we should be using Dagster and actual asset mgmt</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">basemap_path</span> <span class="o">=</span> <span class="n">basemap_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basemap_name</span><span class="si">}</span><span class="s2">.jpg&quot;</span>
    <span class="k">if</span> <span class="n">basemap_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using extant basemap: </span><span class="si">{</span><span class="n">basemap_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating basemap: </span><span class="si">{</span><span class="n">basemap_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">tiff2jpg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basemap_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">basemap_name</span><span class="si">}</span><span class="s2">.tiff&quot;</span><span class="p">,</span> <span class="n">basemap_path</span><span class="p">)</span>
    
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;../templates/css/&#39;</span><span class="p">,</span> <span class="n">webmap_dir</span> <span class="o">/</span> <span class="s2">&quot;css&quot;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>subprocess.run([&lsquo;cp&rsquo;, &lsquo;../templates/js/map.js&rsquo;, f&rdquo;{webmap_dir}/js/&rdquo;])</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">webmap_dir</span> <span class="o">/</span> <span class="s2">&quot;index.html&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating webmap HTML in </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">html_path</span> <span class="o">=</span> <span class="n">generate_map_page</span><span class="p">(</span><span class="s2">&quot;Fire Atlas Webmap&quot;</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">sprite_json</span><span class="p">)</span>  
  
    <span class="k">return</span> <span class="n">output_path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>Generate HTML for edit controls based on attribute configuration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_edit_controls_html</span><span class="p">(</span><span class="n">editable_attributes</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">select_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">string_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">edit_att</span> <span class="ow">in</span> <span class="n">editable_attributes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
            <span class="n">string_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                &lt;div class=&quot;input-group&quot;&gt;</span>
<span class="s2">                    &lt;label&gt;</span><span class="si">{</span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&lt;/label&gt;&lt;br/&gt;</span>
<span class="s2">                    &lt;input type=&quot;text&quot; name=&quot;</span><span class="si">{</span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; id=&quot;</span><span class="si">{</span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; class=&quot;input-field&quot;&gt;</span>
<span class="s2">                &lt;/div&gt;&quot;&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;radio&#39;</span><span class="p">:</span>
            <span class="n">select_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                &lt;div class=&quot;input-group&quot;&gt;</span>
<span class="s2">                    &lt;label&gt;</span><span class="si">{</span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&lt;/label&gt;&lt;br/&gt;</span>
<span class="s2">                    &lt;select name=&quot;</span><span class="si">{</span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; id=&quot;</span><span class="si">{</span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; class=&quot;input-field&quot;&gt;&quot;&quot;&quot;</span>
            
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>parsed_value = json.loads(value)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">str_value</span> <span class="o">=</span>  <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">select_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    &lt;option value=&#39;</span><span class="si">{</span><span class="n">str_value</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">edit_att</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;</span>
<span class="s2">                        </span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="w"> </span><span class="n">edit_att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">   </span>
<span class="s2">                    &lt;/option&gt;&quot;&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>{str_value} {value[ edit_att[&lsquo;name&rsquo;] ] }</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">select_html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/select&gt;&lt;/div&gt;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Add drawing action buttons at the bottom of the editing controls</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">buttons_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;div class=&quot;button-group&quot;&gt;</span>
<span class="s2">            &lt;button id=&quot;reset-button&quot; class=&quot;warning-button&quot;&gt;Reset Drawing&lt;/button&gt;</span>
<span class="s2">            &lt;button id=&quot;upload-button&quot; class=&quot;button&quot;&gt;Upload GeoJSON&lt;/button&gt;</span>
<span class="s2">            &lt;button id=&quot;save-button&quot; class=&quot;button&quot;&gt;Save Features&lt;/button&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">select_html</span> <span class="o">+</span> <span class="n">string_html</span> <span class="o">+</span> <span class="n">buttons_html</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>Generate the complete HTML page for editing a layer. Params: ea - Editable Asset (config) - Atlas config, name - name of the outlet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_edit_page</span><span class="p">(</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ea</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">map_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>Read template files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../templates/edit_map.html&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>Generate controls HTML</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">controls_html</span> <span class="o">=</span> <span class="n">generate_edit_controls_html</span><span class="p">(</span><span class="n">ea</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editable_columns&#39;</span><span class="p">,</span> <span class="p">[]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>Prepare mode string</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">mode_string</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
        <span class="s1">&#39;linestring&#39;</span><span class="p">:</span> <span class="s1">&#39;linestring&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fill&#39;</span><span class="p">:</span> <span class="s1">&#39;polygon&#39;</span><span class="p">,</span>
        <span class="s1">&#39;point&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
        <span class="s1">&#39;polygon&#39;</span><span class="p">:</span> <span class="s1">&#39;polygon&#39;</span>
    <span class="p">}[</span><span class="n">ea</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;annotate&#39;</span><span class="p">:</span>
        <span class="n">mode_string</span> <span class="o">=</span> <span class="s1">&#39;polygon&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>Prepare controls config for JavaScript</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">controls_config</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">att</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">att</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">ea</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editable_columns&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>Format template</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">swale_name</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="n">swalename</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
        <span class="n">edit_layer_name</span><span class="o">=</span><span class="n">ea</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="n">controls_html</span><span class="o">=</span><span class="n">controls_html</span><span class="p">,</span>
        <span class="n">map_config</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">map_config</span><span class="p">[</span><span class="s1">&#39;map_config&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">mode_string</span><span class="o">=</span><span class="n">mode_string</span><span class="p">,</span>
        <span class="n">controls_config</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">controls_config</span><span class="p">),</span>
        <span class="n">legend_targets</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">map_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;legend_targets&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>Generate an interactive web map edit using MapLibre GL JS - one for each editable asset</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_webmap_edit</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">webedit_dir</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">name</span>
    <span class="n">webedit_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>Generate sprite file first if needed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sprite_json</span> <span class="o">=</span> <span class="n">generate_sprite_from_layers</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">webedit_dir</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>Generate base map configuration with sprite</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">map_config</span> <span class="o">=</span> <span class="n">webmap_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sprite_json</span><span class="p">)</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;../templates/css/&#39;</span><span class="p">,</span> <span class="n">webedit_dir</span> <span class="p">])</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;../templates/js/&#39;</span><span class="p">,</span> <span class="n">webedit_dir</span> <span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>subprocess.run([&lsquo;cp&rsquo;, &lsquo;../templates/css/map.css&rsquo;, f&rdquo;{webedit_dir}/css/&rdquo;])
subprocess.run([&lsquo;cp&rsquo;, &lsquo;../templates/css/edit_controls.css&rsquo;, f&rdquo;{webedit_dir}/css/&rdquo;])</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>Copy the JS file
subprocess.run([&lsquo;cp&rsquo;, &lsquo;../templates/js/edit_map.js&rsquo;, f&rdquo;{webedit_dir}/js/&rdquo;])</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      <p>Generate edit pages for each editable asset</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ea</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editable_columns&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;annotate&#39;</span><span class="p">]:</span>
                <span class="n">html_content</span> <span class="o">=</span> <span class="n">generate_edit_page</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">webedit_dir</span> <span class="o">/</span>   <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ea</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">.html&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated WEBEDIT for </span><span class="si">{</span><span class="n">ea</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">webedit_dir</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">grass_init</span><span class="p">(</span><span class="n">swale_name</span><span class="p">):</span>
    <span class="n">grass</span> <span class="o">=</span> <span class="s1">&#39;/usr/bin/grass&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">grass</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="s2">&quot;python_path&quot;</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="kn">import</span> <span class="nn">grass.jupyter</span> <span class="k">as</span> <span class="nn">gj</span>
    <span class="n">my_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">my_env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/usr/lib/grass83/etc/python:</span><span class="si">{</span><span class="n">my_env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">loc_path</span> <span class="o">=</span>  <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/root/grassdata/&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">swale_name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loc_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating Grass LOC: </span><span class="si">{</span><span class="n">loc_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">grass</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;EPSG:4269&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">loc_path</span><span class="p">)],</span> <span class="n">env</span><span class="o">=</span><span class="n">my_env</span><span class="p">))</span>
            
    <span class="n">GRASS_LOC</span> <span class="o">=</span> <span class="n">swale_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>GRASS_LOC = GRASS_LOC_NAME + datetime.datetime.now().strftime(&ldquo;%I:%M%p_%B-%d-%Y&rdquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">gj</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s2">&quot;~/grassdata&quot;</span><span class="p">,</span> <span class="n">GRASS_LOC</span><span class="p">,</span> <span class="s2">&quot;PERMANENT&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p>Grab a region of a layer and export it as a GeoJSON file using GRASS GIS. Note this assumes the entire layer is already in GRASS. Which is awful.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">extract_region_layer_ogr_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">swale_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>  <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.geojson&quot;</span>

    <span class="k">if</span> <span class="n">reuse</span> <span class="ow">and</span> <span class="n">outpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reusing vector file at: </span><span class="si">{</span><span class="n">outpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outpath</span>


    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting region </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> of vector layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">outpath</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">grass_init</span><span class="p">(</span><span class="n">swale_name</span><span class="p">)</span>  
    <span class="kn">import</span> <span class="nn">grass.script</span> <span class="k">as</span> <span class="nn">gs</span>
    <span class="n">clip_bbox</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;g.region&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span><span class="n">e</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">],</span><span class="n">w</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;v.clip&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_clip&#39;</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;v.out.ogr&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_clip&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GeoJSON&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gs</span><span class="o">.</span><span class="n">CalledModuleError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clip was empty for </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Writing empty file.&quot;</span><span class="p">)</span>
        <span class="n">geojson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">geojson</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">([]),</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">outpath</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>Grab a region of a rasterlayer and export it. Note this assumes the entire layer is already in GRASS. Which is awful.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">extract_region_layer_raster_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">use_jpg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">swale_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p>basemap_name = config[&lsquo;assets&rsquo;]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">basemap_dir</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">layer</span>
    <span class="k">if</span> <span class="n">use_jpg</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using JPG&quot;</span><span class="p">)</span>
        <span class="n">basemap_path</span> <span class="o">=</span> <span class="n">basemap_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.tiff.jpg&quot;</span>
        <span class="k">if</span> <span class="n">basemap_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using extant basemap: </span><span class="si">{</span><span class="n">basemap_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">inpath</span> <span class="o">=</span> <span class="n">basemap_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating basemap: </span><span class="si">{</span><span class="n">basemap_path</span><span class="si">}</span><span class="s2"> for layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">tiff2jpg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basemap_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.tiff&quot;</span><span class="p">,</span> <span class="n">basemap_path</span><span class="p">)</span>
            <span class="n">inpath</span> <span class="o">=</span> <span class="n">basemap_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inpath</span> <span class="o">=</span> <span class="n">basemap_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.tiff&quot;</span>
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>  <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.tiff&quot;</span>

    <span class="k">if</span> <span class="n">reuse</span> <span class="ow">and</span> <span class="n">outpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reusing raster file at: </span><span class="si">{</span><span class="n">outpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outpath</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting region </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> of raster layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">outpath</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p>import grass.script as gs
staging_path = f&rdquo;{data_root}/{swale_name}/{version_string}/staging&rdquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">grass_init</span><span class="p">(</span><span class="n">swale_name</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">grass.script</span> <span class="k">as</span> <span class="nn">gs</span>
    <span class="kn">import</span> <span class="nn">grass.jupyter</span> <span class="k">as</span> <span class="nn">gj</span>    
    <span class="n">clip_bbox</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      <p>Can&rsquo;t we extract more efficiently here? We read the whole file then just use part of it - EACH TIME</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.in.gdal&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">inpath</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;g.region&#39;</span><span class="p">,</span> <span class="n">raster</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;g.region&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span><span class="n">e</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">],</span><span class="n">w</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>outpath = f&rdquo;{staging_path}/{layer}_{region[&lsquo;name&rsquo;]}.tiff&rdquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.out.gdal&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">outpath</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <p>Build a map image for a region using GRASS GIS.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">build_region_map_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>
      <p>Args:
    config (dict): The configuration dictionary for the atlas.
    outlet_name (str): The name of the outlet.
    region (dict): The region to build the map for.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">grass_init</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">grass.script</span> <span class="k">as</span> <span class="nn">gs</span>
    <span class="kn">import</span> <span class="nn">grass.jupyter</span> <span class="k">as</span> <span class="nn">gj</span>
    <span class="k">if</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">9000</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2400</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">gj</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">clip_bbox</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;g.region&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span><span class="n">e</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">],</span><span class="n">w</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p>load region layers - if we have any</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;raster&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      <p>First the raster basemap. Note we blend it with a greyscale overlay </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">blend_percent</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blend_percent&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">raster_name</span> <span class="o">=</span> <span class="s1">&#39;hillshadered_&#39;</span> <span class="o">+</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;making map image for </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.in.gdal&#39;</span><span class="p">,</span>  <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;raster&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">raster_name</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.colors&#39;</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="n">raster_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.mapcalc.simple&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.colors&#39;</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey1.0&#39;</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.blend&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">raster_name</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;blended&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="n">blend_percent</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blended raster using percent: </span><span class="si">{</span><span class="n">blend_percent</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        
        <span class="n">m</span><span class="o">.</span><span class="n">d_rast</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="s1">&#39;blended&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      <p>m.d_rast(map=raster_name)<br />
if we don&rsquo;t, we need to set the page size and region directly to 2400x2400</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.mapcalc.simple&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      <p>add vector layers to map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span><span class="n">lp</span> <span class="ow">in</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;vectors&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding region </span><span class="si">{</span><span class="n">lc</span><span class="si">}</span><span class="s2"> to map for region </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="k">for</span> <span class="n">update_key</span><span class="p">,</span> <span class="n">update_value</span> <span class="ow">in</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lc</span><span class="p">[</span><span class="n">update_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_value</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;region config override: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">lc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;v.import&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">lp</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <p>clunky but need to skip empty sets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">lame</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lame</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;layer is empty...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_labels&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding Points&quot;</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">icon</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;icon&quot;</span><span class="p">,</span><span class="s1">&#39;basic/diamond&#39;</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                         <span class="n">label_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                         <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;icon_if&quot;</span><span class="p">):</span>
                <span class="n">icon_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;property&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> == </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conditional POINT icon! </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; [</span><span class="si">{</span><span class="n">icon_sql</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">icon</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;icon&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                         <span class="n">where</span><span class="o">=</span><span class="n">icon_sql</span><span class="p">)</span>

                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding NON-Points&quot;</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">icon</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s1">&#39;basic/diamond&#39;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span> <span class="s2">&quot;pin.png&quot;</span><span class="p">})[</span><span class="s1">&#39;icon&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>
      <p>This is interesting: vector width comes from features or layer conf? Former, right?
m.d_vect(map=lc[&lsquo;name&rsquo;], color=lc.get(&lsquo;color&rsquo;, &lsquo;gray&rsquo;), width=lc.get(&lsquo;width_base&rsquo;,5))
currently, setting bool vector_width IN LAYER means look for more (per-feature) detail in asset.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">c</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_color&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;vector_width&#39;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">fill_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fc</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                         <span class="n">width_column</span><span class="o">=</span><span class="s1">&#39;vector_width&#39;</span><span class="p">,</span>
                         <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
                         <span class="n">label_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">fill_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fc</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                         <span class="n">width</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constant_width&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                         <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
                         <span class="n">label_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;icon_if&quot;</span><span class="p">):</span>
                <span class="n">icon_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;property&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> == </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conditional icon! </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; [</span><span class="si">{</span><span class="n">icon_sql</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;v.centroids&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_centroids&quot;</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_centroids&quot;</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0:0:0&quot;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;0:0:0&quot;</span><span class="p">,</span> <span class="c1">#f&quot;{c[0]}:{c[1]}:{c[2]}&quot;,</span>
                         <span class="n">icon</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;icon_if&#39;</span><span class="p">][</span><span class="s1">&#39;icon&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                         <span class="n">where</span><span class="o">=</span><span class="n">icon_sql</span><span class="p">)</span>





            
    <span class="n">m</span><span class="o">.</span><span class="n">d_grid</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s1">&#39;00:10:00&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p>add neighboring gazeteer text                                                                                                                                              </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">nbr</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gazetteer_neighbors&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nbr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;north&#39;</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">d_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">nbr</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span>  <span class="n">at</span><span class="o">=</span><span class="s2">&quot;50,95&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;south&#39;</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">d_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">nbr</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>  <span class="n">at</span><span class="o">=</span><span class="s2">&quot;50,5&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;west&#39;</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">d_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">nbr</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s2">&quot;5,50&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;east&#39;</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">d_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">nbr</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s2">&quot;95,50&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">d_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s2">&quot;50,50&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      <p>Add legend</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">m</span><span class="o">.</span><span class="n">d_legend_vect</span><span class="p">(</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;220:220:220&quot;</span><span class="p">,</span> <span class="n">border_color</span><span class="o">=</span><span class="s2">&quot;20:20:20&quot;</span><span class="p">,</span> <span class="n">border_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;LEGEND&quot;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      <p>export map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">outpath</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;page_</span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      <p>return path to map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">outpath</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      <p>Process a region extract for a layer.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">process_region</span><span class="p">(</span><span class="n">layer_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">region_extract_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      <p>Current this means only show each name value once.
Args:
    layer_config (dict): The configuration dictionary for the layer.
    region_extract_path (str): The path to the region extract.</p>
<p>load region layer as geopandas</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">region_extract_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>Alternative approach: iterate through unique names to avoid groupby conflicts</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">unique_names</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">unique_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <p>Get all rows with this name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">name_mask</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
            <span class="n">name_indices</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">name_mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>
      <p>Randomly select one row to keep its name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name_mask</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      <p>Set name to empty string for all other rows with this name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">other_indices</span> <span class="o">=</span> <span class="n">name_indices</span><span class="p">[</span><span class="n">name_indices</span> <span class="o">!=</span> <span class="n">keep_idx</span><span class="p">]</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_indices</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <p>Fill any NaN values with empty string
gdf[&lsquo;name&rsquo;] = gdf[&lsquo;name&rsquo;].fillna(None)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-111'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-111'>#</a>
      </div>
      <p>save to new file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">region_extract_path</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">file_stem</span> <span class="o">=</span> <span class="n">region_extract_path</span><span class="o">.</span><span class="n">stem</span>
        <span class="n">file_suffix</span> <span class="o">=</span> <span class="n">region_extract_path</span><span class="o">.</span><span class="n">suffix</span>
        <span class="n">processed_path</span> <span class="o">=</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_stem</span><span class="si">}</span><span class="s2">_processed</span><span class="si">{</span><span class="n">file_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">processed_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GeoJSON&#39;</span><span class="p">)</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">region_extract_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">processed_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">region_extract_path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-112'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-112'>#</a>
      </div>
      <p>Process regions for gazetteer and runbook outputs using versioned paths.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_regions_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">regions_html</span><span class="o">=</span><span class="p">[],</span> <span class="n">skips</span><span class="o">=</span><span class="p">[],</span> <span class="n">reuse_vector_extracts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse_raster_extracts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-113'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-113'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">swale_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;region_maps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skips</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-114'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-114'>#</a>
      </div>
      <p>Set up Grass environment</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">first_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only using first </span><span class="si">{</span><span class="n">first_n</span><span class="si">}</span><span class="s2"> regions...&quot;</span><span class="p">)</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[:</span><span class="n">first_n</span><span class="p">]</span>
        
        <span class="n">grass_init</span><span class="p">(</span><span class="n">swale_name</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">grass.script</span> <span class="k">as</span> <span class="nn">gs</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-115'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-115'>#</a>
      </div>
      <p>Process each input layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outlet_config</span><span class="p">[</span><span class="s1">&#39;in_layers&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">layer_format</span> <span class="o">=</span> <span class="s1">&#39;tiff&#39;</span> <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;raster&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;geojson&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing layer: </span><span class="si">{</span><span class="n">lc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-116'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-116'>#</a>
      </div>
      <p>lc = config[&lsquo;dataswale&rsquo;][&lsquo;layers&rsquo;][layer]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-117'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-117'>#</a>
      </div>
      <p>Resolve staging path then extract data for each region for current layer:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">staging_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">layer_format</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">layer_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geojson&#39;</span><span class="p">]:</span>

                <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;v.import&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">staging_path</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing vector region: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">region_extract_path</span> <span class="o">=</span> <span class="n">extract_region_layer_ogr_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">region</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse_vector_extracts</span><span class="p">)</span>
                    <span class="n">processed_region_extract_path</span> <span class="o">=</span> <span class="n">process_region</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">region_extract_path</span><span class="p">)</span>
                    <span class="n">region</span><span class="p">[</span><span class="s1">&#39;vectors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lc</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">processed_region_extract_path</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.in.gdal&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">staging_path</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>

                    <span class="n">region</span><span class="p">[</span><span class="s1">&#39;raster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lc</span><span class="p">,</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">extract_region_layer_raster_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">region</span><span class="p">,</span> <span class="n">use_jpg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse_raster_extracts</span><span class="p">))]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster region: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  [</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-118'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-118'>#</a>
      </div>
      <p>Build maps for each region</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building map for region: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  [</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="si">}</span><span class="s2">] with wtf config: </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-119'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-119'>#</a>
      </div>
      <p>build_region_minimap(swale_config, swale_config[&lsquo;data_root&rsquo;], swale_name, version_string,  outlet_config[&lsquo;name&rsquo;], region)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">build_region_map_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-120'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-120'>#</a>
      </div>
      <p>save regions config as JSON for later use</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">regions_json_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;regions_config.json&quot;</span>
        <span class="k">if</span> <span class="n">first_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">regions_json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-121'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-121'>#</a>
      </div>
      <p>Post-process to overlay PNG symbols if any were configured
Write output files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">outfile_path</span><span class="p">,</span> <span class="n">outfile_content</span> <span class="ow">in</span> <span class="n">regions_html</span><span class="p">:</span>
        <span class="n">versioned_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="n">outfile_path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-122'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-122'>#</a>
      </div>
      <p>os.makedirs(os.path.dirname(versioned_path), exist_ok=True)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing region output to: </span><span class="si">{</span><span class="n">versioned_path</span><span class="si">}</span><span class="s2">  [</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">versioned_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfile_content</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">regions</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-123'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-123'>#</a>
      </div>
      <p>Load regions from a GeoJSON file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">regions_from_geojson</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-124'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-124'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_region</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">region</span> <span class="ow">in</span>  <span class="nb">enumerate</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s1">&#39;features&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">start_at</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipping region </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hit region limit of </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">, truncating RunBook.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting region </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> from GJ: </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">geojson_to_bbox</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">default_name</span> <span class="o">=</span>  <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">canonicalize_name</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="n">default_name</span><span class="p">)),</span>
                <span class="s1">&#39;caption&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="n">default_name</span><span class="p">),</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">default_name</span><span class="p">),</span>
                <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
                <span class="s2">&quot;neighbors&quot;</span><span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;neighbors&#39;</span><span class="p">),</span>
                <span class="s2">&quot;vectors&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;raster&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
            <span class="p">})</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
            <span class="n">prev_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;prev&quot;</span><span class="p">:</span> <span class="n">regions</span><span class="p">[</span><span class="n">prev_idx</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="n">regions</span><span class="p">[</span><span class="n">next_idx</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]}</span>                 
            
    <span class="k">return</span> <span class="n">regions</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-125'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-125'>#</a>
      </div>
      <p>Create the grid of regions for Gazetteer geometrically and prep them for populating from layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_gazetteerregions</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">):</span>
    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-126'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-126'>#</a>
      </div>
      <p>num_rows = swale_config[&lsquo;geometry&rsquo;][&lsquo;num_rows&rsquo;]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">outlet_config</span><span class="p">[</span><span class="s1">&#39;num_cols&#39;</span><span class="p">]</span>
    <span class="n">cell_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">num_cols</span><span class="p">)</span>
    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">cell_size</span> <span class="p">)</span>
    
    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">everything_region</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
                            <span class="s1">&#39;vectors&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s1">&#39;raster&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-127'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-127'>#</a>
      </div>
      <p>regions.append(everything_region)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">cell_width</span><span class="o">=</span><span class="mi">300</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;table border=3 bgcolor=&#39;#FFFFFF&#39; cellpadding=0 cellspacing=1&gt;</span><span class="se">\n</span><span class="s2">&lt;TR&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
    <span class="n">bdy</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-128'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-128'>#</a>
      </div>
      <p>vd = float(abs(bbox[&lsquo;north&rsquo;] - bbox[&lsquo;south&rsquo;]))/float(num_rows)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">row_index</span> <span class="o">=</span>  <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)[:</span><span class="n">num_rows</span><span class="p">]</span>
    <span class="n">col_index</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">num_cols</span><span class="p">)]</span>
    
    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">rowname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_index</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_index</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">row</span><span class="p">)</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">row</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">col</span><span class="p">)</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">col</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">cell_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-129'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-129'>#</a>
      </div>
      <p>Add neighbors to the region</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">up_row</span> <span class="o">=</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span> 
            <span class="n">down_row</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">left_col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">right_col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span>
         
            <span class="n">up_rowname</span> <span class="o">=</span>  <span class="n">row_index</span><span class="p">[</span><span class="n">up_row</span><span class="p">]</span> <span class="k">if</span> <span class="n">up_row</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">down_rowname</span> <span class="o">=</span> <span class="n">row_index</span><span class="p">[</span><span class="n">down_row</span><span class="p">]</span> <span class="k">if</span> <span class="n">down_row</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">right_colname</span> <span class="o">=</span> <span class="n">right_col</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">right_col</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_index</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">left_colname</span> <span class="o">=</span> <span class="n">left_col</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">left_col</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">neighbors</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;north&quot;</span> <span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">up_rowname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">up_rowname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;south&quot;</span> <span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">down_rowname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">down_rowname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;west&quot;</span> <span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">left_colname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;east&quot;</span> <span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">right_colname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">}</span>

          
            
            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">cell_name</span><span class="p">,</span> 
                            <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;south&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span><span class="s1">&#39;west&#39;</span><span class="p">:</span><span class="n">w</span><span class="p">,</span><span class="s1">&#39;north&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span><span class="s1">&#39;east&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
                            <span class="s1">&#39;gazetteer_neighbors&#39;</span><span class="p">:</span> <span class="n">neighbors</span><span class="p">,</span>
                            <span class="s1">&#39;vectors&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s1">&#39;raster&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bdy</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TR&gt;&lt;TD&gt;</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TD&gt;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span>
            <span class="n">bdy</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TD&gt;&lt;A HREF=&#39;page_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">.png&#39;&gt;&lt;img src=&#39;page_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">.png&#39; alt=&#39;Avatar&#39; class=&#39;image&#39;style=&#39;width:</span><span class="si">{</span><span class="n">cell_width</span><span class="si">}</span><span class="s2">&#39;&gt;&lt;/A&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">bdy</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">hdr</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">bdy</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/TABLE&gt;&lt;/BODY&gt;&lt;/HTML&gt;&quot;</span>
    <span class="n">html_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="s2">&quot;index.html&quot;</span>
    <span class="k">return</span> <span class="n">regions</span><span class="p">,</span> <span class="p">[(</span><span class="n">html_path</span><span class="p">,</span> <span class="n">hdr</span> <span class="o">+</span> <span class="n">bdy</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-130'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-130'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">make_gazetteer_html</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">):</span>
    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-131'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-131'>#</a>
      </div>
      <p>num_rows = swale_config[&lsquo;geometry&rsquo;][&lsquo;num_rows&rsquo;]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">outlet_config</span><span class="p">[</span><span class="s1">&#39;num_cols&#39;</span><span class="p">]</span>
    <span class="n">cell_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">num_cols</span><span class="p">)</span>
    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">cell_size</span> <span class="p">)</span>

    <span class="n">cell_width</span><span class="o">=</span><span class="mi">300</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;table border=3 bgcolor=&#39;#FFFFFF&#39; cellpadding=0 cellspacing=1&gt;</span><span class="se">\n</span><span class="s2">&lt;TR&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
    <span class="n">bdy</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="n">row_index</span> <span class="o">=</span>  <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)[:</span><span class="n">num_rows</span><span class="p">]</span>
    <span class="n">col_index</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">num_cols</span><span class="p">)]</span>
    
    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">rowname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_index</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_index</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">row</span><span class="p">)</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">row</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">col</span><span class="p">)</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">col</span><span class="o">*</span><span class="n">cell_size</span>
            <span class="n">cell_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bdy</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TR&gt;&lt;TD valign=&#39;center&#39;&gt;</span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;B&gt;&lt;FONT SIZE=&#39;+3&#39;&gt;</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TD align=&#39;center&#39;&gt;</span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font size=&#39;+3&#39;&gt;&lt;b&gt;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;/font&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; </span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span>
            <span class="n">bdy</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TD&gt;&lt;A HREF=&#39;page_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">.html&#39;&gt;&lt;img src=&#39;page_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">.png&#39; alt=&#39;Avatar&#39; class=&#39;image&#39;style=&#39;width:</span><span class="si">{</span><span class="n">cell_width</span><span class="si">}</span><span class="s2">&#39;&gt;&lt;/A&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">html_cell_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;page_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">.html&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">html_cell_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;center&gt;&lt;font size=&#39;+4&#39;&gt;&lt;b&gt;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;img src=&#39;page_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rowname</span><span class="si">}</span><span class="s2">.png&#39; width=&#39;1000px&#39;&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">bdy</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">hdr</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">bdy</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/TABLE&gt;&lt;/BODY&gt;&lt;/HTML&gt;&quot;</span>
    <span class="n">html_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="s2">&quot;index2.html&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">html_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hdr</span><span class="o">+</span><span class="n">bdy</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">html_path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-132'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-132'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_gazetteer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">skips</span><span class="o">=</span><span class="p">[],</span> <span class="n">first_n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">gaz_regions</span><span class="p">,</span> <span class="n">gaz_html</span> <span class="o">=</span> <span class="n">generate_gazetteerregions</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span>  <span class="n">outlet_regions_grass</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">gaz_regions</span><span class="p">,</span> <span class="n">gaz_html</span><span class="p">,</span> <span class="n">skips</span><span class="o">=</span><span class="n">skips</span><span class="p">,</span> <span class="n">first_n</span><span class="o">=</span><span class="n">first_n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-133'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-133'>#</a>
      </div>
      <p>For a swale&rsquo;s &ldquo;regions&rdquo; layer, generate a runbook. This comprises a series of pages, one per region, linked by the &ldquo;neighbor&rdquo; array Property.
The HTML runbook is a simple HTML page with a list of links to the region pages, and a link to the home page. 
The PDF runbook is a simple PDF page with a list of links to the region pages, and a link to the home page.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_runbook</span><span class="p">(</span> <span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">skips</span><span class="o">=</span><span class="p">[],</span> <span class="n">start_at</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-134'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-134'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-135'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-135'>#</a>
      </div>
      <p>regions = outlet_config[&lsquo;regions&rsquo;]
get regions layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">regions_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;regions&quot;</span> <span class="o">/</span> <span class="s2">&quot;regions.geojson&quot;</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">regions_from_geojson</span><span class="p">(</span><span class="n">regions_path</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="n">start_at</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="n">swale_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">outlet_dir</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> 
    <span class="n">index_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Run Book&lt;/h1&gt;&lt;ul&gt;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
        <span class="n">index_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;li&gt;&lt;a href=&#39;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.html&#39;&gt;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;caption&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/a&gt;&lt;/li&gt;&quot;</span>
    <span class="n">index_html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outlet_dir</span><span class="si">}</span><span class="s2">/index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index_html</span><span class="p">)</span>
    
    <span class="n">html_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;/body&gt;&lt;table&gt;&lt;tr&gt;&lt;TD&gt;&lt;!--&lt;A HREF=&quot;../runbook/&quot;&gt;&lt;img src=&#39;page_</span><span class="si">{name}</span><span class="s2">_minimap.png&#39; width=400/&gt;&lt;/A&gt;--&gt;&lt;/TD&gt;&lt;/td&gt;</span>
<span class="s2">&lt;td&gt;</span>
<span class="s2">&lt;center&gt;&lt;h1&gt;</span><span class="si">{caption}</span><span class="s2">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="s2">&lt;pre&gt;</span><span class="si">{map_collar}</span><span class="s2">&lt;/pre&gt;</span>
<span class="s2">&lt;center&gt;&lt;p&gt;</span><span class="si">{text}</span><span class="s2">&lt;/p&gt;&lt;i&gt;Click map to zoom, advance to previous/next page in RunBook, or &quot;Home&quot; to return to menu.&lt;/i&gt;&lt;hr&gt;</span>
<span class="si">{neighbor_links_html}</span>
<span class="s2">&lt;a href=&quot;..&quot;&gt;HOME&lt;/a&gt;&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/TABLE&gt;</span>
<span class="s2">&lt;a href=&#39;region_</span><span class="si">{name}</span><span class="s2">.png&#39;&gt;&lt;img src=&#39;page_</span><span class="si">{name}</span><span class="s2">.png&#39; width=1200/&gt;&lt;/a&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-136'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-136'>#</a>
      </div>
      <p>outpath_template = outlet_config[&lsquo;outpath_template&rsquo;].format(**swale_config)
   (<a href='{swale_name}_page_{prev_region}.html'>prev</a>) (<a href='{swale_name}_page_{next_region}.html'>next</a>)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">gaz_html</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">md</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;---</span>
<span class="s2">geometry: margin=1cm</span>
<span class="s2">---</span>
<span class="s2">#DIVIDER</span>

<span class="s2">#DIVIDER</span>
<span class="s2">    data_path = versioning.atlas_path(config, &quot;outlets&quot;) / outlet_name /  &quot;atlas.db&quot;</span>
<span class="s2">    logger.info(f&quot;Querying DDB: </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;)</span>
<span class="s2">    with duckdb.connect(str(data_path)) as conn:</span>
<span class="s2">        conn.execute(&quot;INSTALL spatial; LOAD spatial; &quot;)</span>
<span class="s2">        return conn.execute(query).fetchall()</span>
<span class="s2">#DIVIDER</span>
<span class="s2">def sql_query(config: dict, outlet_name: str, query: str, return_format: str = &#39;csv&#39;):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    result_rows = sql_query_duckdb(config, outlet_name, query)</span>

<span class="s2">    file_like = StringIO()</span>
<span class="s2">    if return_format == &#39;json&#39;:</span>
<span class="s2">        json.dump(result_rows, file_like)</span>
<span class="s2">        return file_like.getvalue()</span>

<span class="s2">    elif return_format == &#39;csv&#39;:</span>
<span class="s2">        </span>
<span class="s2">        writer = csv.writer(file_like)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">        for row in result_rows:</span>
<span class="s2">            writer.writerow(row)</span>
<span class="s2">        </span>
<span class="s2">    else:</span>
<span class="s2">        raise ValueError(f&quot;Invalid return format: </span><span class="si">{</span><span class="n">return_format</span><span class="si">}</span><span class="s2">&quot;)</span>
<span class="s2">    return file_like.getvalue()</span>
<span class="s2">#DIVIDER</span>
<span class="s2">def make_attribution_html(atlas_config, swale_config, lc):</span>
<span class="s2">    outpath = versioning.atlas_path(atlas_config, &quot;outlets&quot;) / swale_config[&#39;name&#39;] / f&quot;</span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="s2">    </span>
<span class="s2">    download_uri = lc.get(&#39;inpath_template&#39;, &#39;outpath_template&#39;)</span>
<span class="s2">    os.makedirs(outpath, exist_ok=True)</span>
<span class="s2">    with open(outpath + &quot;/attribution.html&quot;, &quot;w&quot;) as f:</span>
<span class="s2">        f.write(f&quot;&quot;&quot;</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Description</span><span class="p">:</span> <span class="p">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;attribution&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">About</span><span class="p">:</span> <span class="p">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;attribution&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Source</span><span class="p">:</span> <span class="p">{</span><span class="n">download_uri</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">License</span><span class="p">:</span> <span class="p">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;attribution&#39;</span><span class="p">][</span><span class="s1">&#39;license&#39;</span><span class="p">]}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;)</span>
<span class="sd">#DIVIDER</span>
<span class="sd">def make_root_html(root_path_str):</span>
<span class="sd">#DIVIDER</span>
<span class="sd">    root_path = Path(root_path_str)</span>
<span class="sd">    atlas_config_path_list = list(root_path.glob(&#39;*/staging/atlas_config.json&#39;))</span>
<span class="sd">#DIVIDER</span>
<span class="sd">    atlas_path_list = [x.parent.parent.relative_to(root_path) for x in atlas_config_path_list]</span>
<span class="sd">    logger.info(f&quot;In root {root_path} found: {list(atlas_path_list)}...&quot;)</span>
<span class="sd">    atlas_name_list = [json.load(open(x))[&#39;name&#39;] for x in atlas_config_path_list]</span>
<span class="sd">#DIVIDER</span>
<span class="sd">    atlas_html = &quot;&quot;&quot;</span><span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">style</span><span class="o">&gt;</span>
      <span class="n">body</span> <span class="p">{</span>
	  <span class="n">background</span><span class="o">-</span><span class="n">image</span><span class="p">:</span> <span class="n">url</span><span class="p">(</span><span class="s1">&#39;http://fireatlas.org/bearbutte1.jpeg&#39;</span><span class="p">);</span>
	  <span class="n">background</span><span class="o">-</span><span class="n">repeat</span><span class="p">:</span> <span class="n">no</span><span class="o">-</span><span class="n">repeat</span><span class="p">;</span>
	  <span class="n">background</span><span class="o">-</span><span class="n">attachment</span><span class="p">:</span> <span class="n">fixed</span><span class="p">;</span>
	  <span class="n">background</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="mi">100</span><span class="o">%</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">style</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/local/css/console.css&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">center</span><span class="o">&gt;&lt;</span><span class="n">font</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;+2&quot;</span><span class="o">&gt;</span>
      <span class="n">f</span> <span class="n">i</span> <span class="n">r</span> <span class="n">e</span> <span class="n">a</span> <span class="n">t</span> <span class="n">l</span> <span class="n">a</span> <span class="n">s</span> <span class="o">.</span> <span class="n">o</span> <span class="n">r</span> <span class="n">g</span>
      <span class="o">&lt;/</span><span class="n">font</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">hr</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;30%&quot;</span><span class="o">&gt;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-137'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-137'>#</a>
      </div>
      <p>{swale_name} RunBook</p>
<pre><code>for i,r in enumerate(regions):
    # r['next_region']=(i+1) % len(regions)
    # r['prev_region']=(i-1) % len(regions)
    nbr_links = [f"&lt;a href='{nbr_name}.html'&gt;{nbr_dir}&lt;/a&gt;" for nbr_dir, nbr_name in r.get('neighbors',{}).items()]
    nbr_links_html = " | ".join(nbr_links)

    map_collar = "None" #build_map_collar(config, swale_name, r['bbox'], layers = outlet_config['layers'])
    gaz_html.append(
        #(outlet_config['config']['outpath_template'].format(
        #    i=i,region_name=r['name'],**config).lower(),
        (outlet_dir / f"{r['name']}.html",
        html_template.format(i=i, region_name=r['name'], neighbor_links_html=nbr_links_html,
                              swale_name=swale_name, map_collar=map_collar, **r)))
    md += f"![{r['name']}]({outlet_dir}/page_{r['name']}.png){{ width=800px }}\n\n"
with open(f"{outlet_dir}/dataswale.md", "w") as f:
    f.write(md)
if 'region_content' not in skips:
    res =  outlet_regions_grass(config, outlet_name, regions, gaz_html, skips=skips)
if 'pdf' not in skips:
    print(subprocess.check_output(['pandoc', f"{outlet_dir}/dataswale.md", '-o', f"{outlet_dir}/runbook.pdf"]))

return regions
</code></pre>
<p>def outlet_sql_duckdb(config: dict, outlet_name: str):
Create static DDB tables for SQL queries.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making Console for </span><span class="si">{</span><span class="n">console_type</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-138'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-138'>#</a>
      </div>
      <p>outlet_config = config[&lsquo;assets&rsquo;][outlet_name]
data_path = versioning.atlas_path(config, &ldquo;outlets&rdquo;) / outlet_name /  &ldquo;atlas.db&rdquo;
with duckdb.connect(str(data_path)) as conn:
    conn.execute(&ldquo;INSTALL spatial; LOAD spatial; &ldquo;)
    for layer in config[&lsquo;dataswale&rsquo;][&lsquo;layers&rsquo;]:
        if layer[&lsquo;geometry_type&rsquo;] == &lsquo;raster&rsquo;:
            logger.info(f&rdquo;skipping raster layer {layer[&lsquo;name&rsquo;]}&hellip;&rdquo;)
            continue
        if layer[&lsquo;name&rsquo;] not in outlet_config.get(&lsquo;layers&rsquo;, config[&lsquo;dataswale&rsquo;][&lsquo;layers&rsquo;]):
            logger.info(f&rdquo;skipping un-included layer {layer[&lsquo;name&rsquo;]} from { outlet_config.get(&lsquo;layers&rsquo;, config[&lsquo;dataswale&rsquo;][&lsquo;layers&rsquo;])}&hellip;&rdquo;)
            continue
        layer_path = versioning.atlas_path(config, &ldquo;layers&rdquo;) / layer[&lsquo;name&rsquo;] / f&rdquo;{layer[&lsquo;name&rsquo;]}.geojson&rdquo;
        logger.info(f&rdquo;Creating DDB tables for {layer_path} into {data_path}.&rdquo;)
        sql = f&rdquo;DROP TABLE IF EXISTS {layer[&lsquo;name&rsquo;]}; ;CREATE TABLE {layer[&lsquo;name&rsquo;]} AS SELECT * FROM ST_Read(&lsquo;{layer_path}&rsquo;);&rdquo;</p>
<pre><code>    logger.info(f"executing SQL: {sql}")
    conn.execute(sql)
</code></pre>
<p>return data_path</p>
<p>def sql_query_duckdb(config: dict, outlet_name: str, query: str):
Query the DDB for an outlet.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">template_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../templates/console.html&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-139'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-139'>#</a>
      </div>
      <p>Query the DDB for an outlet.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;version_string&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version_string&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">),</span>
        <span class="s1">&#39;versions&#39;</span><span class="p">:</span> <span class="n">displayed_versions</span><span class="p">,</span>
        <span class="s1">&#39;logo&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;swaleName&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="s1">&#39;consoleType&#39;</span><span class="p">:</span> <span class="n">console_type</span><span class="p">,</span>
        <span class="s1">&#39;panelHeader&#39;</span><span class="p">:</span> <span class="n">panel_header</span><span class="p">,</span>
        <span class="s1">&#39;interfaces&#39;</span><span class="p">:</span> <span class="n">displayed_interfaces</span><span class="p">,</span>
        <span class="s1">&#39;downloads&#39;</span><span class="p">:</span> <span class="n">displayed_downloads</span><span class="p">,</span>
        <span class="s1">&#39;useCases&#39;</span><span class="p">:</span> <span class="n">use_cases</span><span class="p">,</span>
        <span class="s1">&#39;spreadsheets&#39;</span><span class="p">:</span> <span class="n">spreadsheets</span><span class="p">,</span>
        <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="n">displayed_inlets</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-140'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-140'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">script_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;script&gt;initializePage(</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">);&lt;/script&gt;&#39;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/body&gt;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">script_tag</span><span class="si">}</span><span class="s1">&lt;/body&gt;&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">html</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-141'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-141'>#</a>
      </div>
      <p>writer.writerow(result_rows[0].keys())</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">make_swale_html</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_config</span><span class="p">,</span> <span class="n">store_materialized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-142'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-142'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">version_string</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version_string&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-143'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-143'>#</a>
      </div>
      <p>Given a root directory path, make a root html file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">outpath</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-144'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-144'>#</a>
      </div>
      <p>This will be a list of the atlases available. We get that from looking for subdirectories with atlas_config.json file.
The root html file will have links to the atlases. The text of the link is just the name given in the atlas_config.json file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-145'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-145'>#</a>
      </div>
      <p>logger.info(f&rdquo;In root {root_path} found: {list(atlas_config_path_list)}&hellip;&rdquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">css_dir</span> <span class="o">=</span>  <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;css&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating CSS dir: </span><span class="si">{</span><span class="n">css_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">css_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;../templates/css/console.css&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">css_dir</span><span class="p">)])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-146'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-146'>#</a>
      </div>
      <p>logger.info(f&rdquo;In root {root_path} found: {list(atlas_name_list)}&hellip;&rdquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">public_interfaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ac</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">ac</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outlet&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;interface&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,[</span><span class="s1">&#39;public&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-147'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-147'>#</a>
      </div>
      <pre><code>atlas_html += "&lt;HR width='40%'&gt;&lt;UL&gt;"
atlas_html += "\n".join( [f"&lt;LI&gt;&lt;A HREF='{a}/index.html'&gt;{b}&lt;/A&gt;&lt;/LI&gt;" for a,b in zip(atlas_path_list, atlas_name_list) ] )

atlas_html += "&lt;/UL&gt;&lt;/CENTER&gt;&lt;/BODY&gt;&lt;/HTML&gt;"
outpath = f"{root_path}/index.html"
logger.info(atlas_html)
with open(outpath, "w") as f:
    f.write(atlas_html)
return outpath
</code></pre>
<p>def make_console_html(config,
                      displayed_interfaces=[], displayed_downloads=[], displayed_inlets=[], displayed_versions=[], spreadsheets={},
                      admin_controls=[], console_type=&rsquo;ADMINISTRATION&rsquo;, panel_header=&rdquo;&ldquo;, use_cases=[]):
Generate HTML for the console interface.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>
    
    <span class="n">public_downloads</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ac</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">ac</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outlet&#39;</span>
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,[</span><span class="s1">&#39;public&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-148'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-148'>#</a>
      </div>
      <p>Read the template file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>
    
    <span class="n">internal_interfaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ac</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">ac</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outlet&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;interface&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,[</span><span class="s1">&#39;public&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;internal&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-149'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-149'>#</a>
      </div>
      <p>Prepare the data for the template</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated Internal interfaces: </span><span class="si">{</span><span class="n">internal_interfaces</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">internal_downloads</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ac</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,[</span><span class="s1">&#39;public&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;internal&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-150'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-150'>#</a>
      </div>
      <p>Insert the data initialization script</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="ow">and</span> <span class="n">ac</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outlet&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-151'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-151'>#</a>
      </div>
      <p>Generate HTML for the swale interface.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>
    
    <span class="n">admin_interfaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ac</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">ac</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outlet&#39;</span>
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;interface&#39;</span>         
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,[</span><span class="s1">&#39;public&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-152'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-152'>#</a>
      </div>
      <p>Get version string</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated Admin interfaces: </span><span class="si">{</span><span class="n">admin_interfaces</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">admin_downloads</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ac</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">ac</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outlet&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-153'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-153'>#</a>
      </div>
      <p>Create output directory</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span> 
        <span class="ow">and</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,[</span><span class="s1">&#39;public&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;internal&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-154'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-154'>#</a>
      </div>
      <p>outpath.mkdir(parents=True, exist_ok=True)
logger.info(f&rdquo;Created output directory: {outpath}&rdquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>

    <span class="n">admin_layers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">lc</span> <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataswale&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;interface&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-155'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-155'>#</a>
      </div>
      <p>Copy CSS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated Admin Layers: </span><span class="si">{</span><span class="n">admin_layers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-156'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-156'>#</a>
      </div>
      <p>Get interfaces and downloads based on access level</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">use_cases</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;add_road&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: Add a new road.&quot;</span><span class="p">,</span> <span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;add_building&quot;</span> <span class="p">:[</span><span class="s2">&quot;Howto: Add a new building.&quot;</span><span class="p">,</span> <span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;download_geojson&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: Download vector layer as GeoJSON.&quot;</span><span class="p">,</span> <span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;download_gpkg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: Download atlas as GeoPKG&quot;</span><span class="p">,</span> <span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;download_runbook&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: download Run Book&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;download_runbook&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: Hide/Show layers in interactive web map.&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;hide_layers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: Hide/Show layers in interactive web map.&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;upload_geojson&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Howto: Add a GeoJSON file to an existing vector layer.&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;platform_overview&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Overview of Stewardship Atlas Platform&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;python_overview&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Python Documentation&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">],</span>
                 <span class="s2">&quot;schema_overview&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Schema Documentation&quot;</span><span class="p">,</span><span class="s2">&quot;https://internal.fireatlas.org/documentation/&quot;</span><span class="p">]</span>
                 
                 <span class="p">}</span>
                                   
    <span class="n">user_cases_config</span> <span class="o">=</span> <span class="p">[</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-157'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-157'>#</a>
      </div>
      <p>and ac.get(&lsquo;access&rsquo;) == &lsquo;public&rsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;VFD Member&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_runbook&quot;</span><span class="p">,</span> <span class="s2">&quot;download_gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;hide_layers&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;VFD Administrator&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;add_road&#39;</span><span class="p">,</span> <span class="s1">&#39;add_building&#39;</span><span class="p">,</span> <span class="s1">&#39;download_gpkg&#39;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;GIS Practitioner&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;platform_overview&quot;</span><span class="p">,</span><span class="s1">&#39;download_geojson&#39;</span><span class="p">,</span> <span class="s1">&#39;download_gpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;add_road&#39;</span><span class="p">,</span> <span class="s1">&#39;add_building&#39;</span><span class="p">,</span> <span class="s2">&quot;upload_geojson&quot;</span><span class="p">,</span> <span class="s2">&quot;schema_overview&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Developer&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;platform_overview&quot;</span><span class="p">,</span> <span class="s2">&quot;python_overview&quot;</span><span class="p">,</span> <span class="s2">&quot;schema_overview&quot;</span><span class="p">,</span> <span class="s2">&quot;download_gpkg&quot;</span><span class="p">]}</span>
        <span class="p">]</span>
    <span class="n">user_cases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">user_cases_config</span><span class="p">:</span>
        <span class="n">uc</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">use_cases</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">use_cases</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">u</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]]</span>
        <span class="n">user_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">u</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;cases&#39;</span><span class="p">:</span> <span class="n">uc</span><span class="p">}</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-158'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-158'>#</a>
      </div>
      <p>and ac.get(&lsquo;interaction&rsquo;) == &lsquo;download&rsquo; 
and ac.get(&lsquo;access&rsquo;) == &lsquo;public&rsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">admin_html</span> <span class="o">=</span> <span class="n">make_console_html</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">console_type</span><span class="o">=</span><span class="s1">&#39;ADMINISTRATION&#39;</span><span class="p">,</span>
        <span class="n">panel_header</span> <span class="o">=</span> <span class="s1">&#39;Layer operations and Access&#39;</span><span class="p">,</span>        
        <span class="n">displayed_interfaces</span><span class="o">=</span><span class="n">admin_interfaces</span><span class="p">,</span> 
        <span class="n">displayed_downloads</span><span class="o">=</span><span class="n">admin_downloads</span><span class="p">,</span> 
        <span class="n">displayed_inlets</span><span class="o">=</span><span class="n">admin_layers</span><span class="p">,</span>
        <span class="n">spreadsheets</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;spreadsheets&#39;</span><span class="p">],</span>
        <span class="n">displayed_versions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;version_string&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="p">[])],</span>
        <span class="n">admin_controls</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">use_cases</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    
    <span class="n">admin_path</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">admin_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">admin_path</span> <span class="o">/</span> <span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">admin_html</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote admin view to: </span><span class="si">{</span><span class="n">admin_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-159'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-159'>#</a>
      </div>
      <p>and ac.get(&lsquo;interaction&rsquo;) == &lsquo;interface&rsquo; 
and ac.get(&lsquo;access&rsquo;) in (&lsquo;internal&rsquo;, &lsquo;public&rsquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">internal_html</span> <span class="o">=</span> <span class="n">make_console_html</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">console_type</span><span class="o">=</span><span class="s1">&#39;INTERNAL&#39;</span><span class="p">,</span>
        <span class="n">panel_header</span> <span class="o">=</span> <span class="s1">&#39;Help and How-To&#39;</span><span class="p">,</span>
        <span class="n">displayed_interfaces</span><span class="o">=</span><span class="n">internal_interfaces</span><span class="p">,</span> 
        <span class="n">displayed_downloads</span><span class="o">=</span><span class="n">internal_downloads</span><span class="p">,</span> 
        <span class="n">displayed_inlets</span><span class="o">=</span><span class="p">[],</span> 
        <span class="n">displayed_versions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;version_string&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="p">[])],</span>
        <span class="n">admin_controls</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">use_cases</span><span class="o">=</span><span class="n">user_cases</span>
    <span class="p">)</span>
    
    <span class="n">internal_path</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s2">&quot;internal&quot;</span> 
    <span class="n">internal_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">internal_path</span><span class="o">/</span> <span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">internal_html</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote internal view to: </span><span class="si">{</span><span class="n">internal_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-160'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-160'>#</a>
      </div>
      <p>if ac.get(&lsquo;interaction&rsquo;) == &lsquo;download&rsquo; </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">public_html</span> <span class="o">=</span> <span class="n">make_console_html</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">console_type</span><span class="o">=</span><span class="s1">&#39;PUBLIC&#39;</span><span class="p">,</span>
        <span class="n">panel_header</span> <span class="o">=</span> <span class="s1">&#39;Help and How-to&#39;</span><span class="p">,</span>
        <span class="n">displayed_interfaces</span><span class="o">=</span><span class="n">public_interfaces</span><span class="p">,</span> 
        <span class="n">displayed_downloads</span><span class="o">=</span><span class="n">public_downloads</span><span class="p">,</span> 
        <span class="n">displayed_inlets</span><span class="o">=</span><span class="p">[],</span> 
        <span class="n">displayed_versions</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">use_cases</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">admin_controls</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Internal&quot;</span><span class="p">,</span> <span class="s2">&quot;internal.html&quot;</span><span class="p">)]</span>
    <span class="p">)</span>
    
    <span class="n">public_path</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s2">&quot;public&quot;</span>
    <span class="n">public_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">public_path</span> <span class="o">/</span> <span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">public_html</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote public view to: </span><span class="si">{</span><span class="n">public_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outpath</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-161'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-161'>#</a>
      </div>
      <p>and ac.get(&lsquo;access&rsquo;) in (&lsquo;internal&rsquo;, &lsquo;public&rsquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_html</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-162'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-162'>#</a>
      </div>
      <p>and ac.get(&lsquo;interaction&rsquo;) == &lsquo;interface&rsquo; 
and ac.get(&lsquo;access&rsquo;) in (&lsquo;admin&rsquo;, &lsquo;internal&rsquo;, &lsquo;public&rsquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-163'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-163'>#</a>
      </div>
      <p>and ac.get(&lsquo;interaction&rsquo;) == &lsquo;download&rsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">make_swale_html</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_config</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-164'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-164'>#</a>
      </div>
      <p>and ac.get(&lsquo;access&rsquo;) in (&lsquo;admin&rsquo;, &lsquo;internal&rsquo;, &lsquo;public&rsquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_sqlquery</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-165'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-165'>#</a>
      </div>
      <p>and ac.get(&lsquo;access&rsquo;,[&lsquo;public&rsquo;]).count(&lsquo;admin&rsquo;) &gt; 0    <br />
and ac.get(&lsquo;interaction&rsquo;) == &lsquo;interface&rsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">outlet_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">]</span>
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span>
    <span class="n">outpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-166'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-166'>#</a>
      </div>
      <p>Define use cases</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">css_dir</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s1">&#39;css&#39;</span>
    <span class="n">js_dir</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s1">&#39;js&#39;</span>
    <span class="n">css_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">js_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-167'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-167'>#</a>
      </div>
      <p>{&ldquo;name&rdquo;: &ldquo;Firefighter&rdquo;, &ldquo;cases&rdquo;: [&ldquo;Download Avenza version&rdquo;, &ldquo;Share a QR Code for Avenza&rdquo;, &ldquo;Mark an Incident&rdquo;, &ldquo;Mark a POI&rdquo;]},
{&ldquo;name&rdquo;: &ldquo;GIS Practitioner&rdquo;, &ldquo;cases&rdquo;: [&ldquo;Download Layer GeoJSON&rdquo;, &ldquo;Download GeoPKG&rdquo;, &ldquo;Add a layer as GeoJSON&rdquo;]},
{&ldquo;name&rdquo;: &ldquo;Administrator&rdquo;, &ldquo;cases&rdquo;: [&ldquo;Go to Admin interface&rdquo;, &ldquo;Switch Version&rdquo;]},</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sqldb_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sqldb&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">available_tables</span> <span class="o">=</span> <span class="n">sqldb_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;layers&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">tables_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">available_tables</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">sql_query</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;SELECT column_name FROM information_schema.columns WHERE table_name = &#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">columns_list</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;&lt;li&gt;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">&lt;/li&gt;&#39;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])</span>
        <span class="n">tables_list</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;li&gt;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">columns_list</span><span class="si">}</span><span class="s1">&lt;/li&gt;</span><span class="se">\n</span><span class="s1">&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-168'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-168'>#</a>
      </div>
      <p>Generate admin view</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../templates/sqlquery.html&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-169'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-169'>#</a>
      </div>
      <p>Generate internal view</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{atlas_name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{tables_list}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tables_list</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-170'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-170'>#</a>
      </div>
      <p>Generate public view</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-171'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-171'>#</a>
      </div>
      <p>Generate HTML for all outlets.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;../templates/css/sqlquery.css&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">css_dir</span><span class="p">)])</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;../templates/js/sqlquery.js&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">js_dir</span><span class="p">)])</span>
    
    <span class="k">return</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span>
   
<span class="c1">#blah = &quot;&quot;&quot;</span>
<span class="n">asset_methods</span> <span class="o">=</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-172'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-172'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="s1">&#39;html&#39;</span><span class="p">:</span> <span class="n">outlet_html</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-173'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-173'>#</a>
      </div>
      <p>Create HTML for each swale
for swale in config.get(&lsquo;dataswales&rsquo;, []):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="s1">&#39;runbook&#39;</span><span class="p">:</span> <span class="n">outlet_runbook</span><span class="p">,</span>
    <span class="s1">&#39;webmap&#39;</span><span class="p">:</span> <span class="n">outlet_webmap</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-174'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-174'>#</a>
      </div>
      <p>Generate HTML interface for SQL queries.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="s1">&#39;webedit&#39;</span><span class="p">:</span> <span class="n">outlet_webmap_edit</span><span class="p">,</span>
    <span class="s1">&#39;sqlquery&#39;</span><span class="p">:</span> <span class="n">outlet_sqlquery</span>
<span class="p">}</span>
<span class="c1">#&quot;&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-175'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-175'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_overlay_png_symbols_on_map</span><span class="p">(</span><span class="n">map_image_path</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-176'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-176'>#</a>
      </div>
      <p>Create CSS and JS directories</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-177'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-177'>#</a>
      </div>
      <p>Get available tables from sqldb outlet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">map_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">map_image_path</span><span class="p">)</span>
        <span class="n">map_width</span><span class="p">,</span> <span class="n">map_height</span> <span class="o">=</span> <span class="n">map_img</span><span class="o">.</span><span class="n">size</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-178'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-178'>#</a>
      </div>
      <p>Read and process template</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">bbox</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
        <span class="n">region_width</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span>
        <span class="n">region_height</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-179'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-179'>#</a>
      </div>
      <p>Replace placeholders</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;vectors&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">png_config</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png_symbol&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">png_config</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">png_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
                
            <span class="n">png_path</span> <span class="o">=</span> <span class="n">png_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
            <span class="n">png_size</span> <span class="o">=</span> <span class="n">png_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-180'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-180'>#</a>
      </div>
      <p>Write processed template</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">png_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG symbol file not found: </span><span class="si">{</span><span class="n">png_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-181'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-181'>#</a>
      </div>
      <p>Copy CSS and JS files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">try</span><span class="p">:</span>
                <span class="n">png_symbol</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">png_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-182'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-182'>#</a>
      </div>
      <p>&lsquo;outlet_gpkg&rsquo;: outlet_gpkg,
&lsquo;tiff&rsquo;: outlet_tiff,
&lsquo;pdf&rsquo;: outlet_geopdf,</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">png_symbol</span> <span class="o">=</span> <span class="n">png_symbol</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">png_size</span><span class="p">,</span> <span class="n">png_size</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load PNG symbol </span><span class="si">{</span><span class="n">png_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-183'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-183'>#</a>
      </div>
      <p>&lsquo;gazetteer&rsquo;: outlet_gazetteer,</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">geojson_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">geojson_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Point&#39;</span><span class="p">:</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>
                        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-184'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-184'>#</a>
      </div>
      <p>&lsquo;webmap_public&rsquo;: outlet_webmap,</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lon</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">region_width</span> <span class="o">*</span> <span class="n">map_width</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat</span><span class="p">)</span> <span class="o">/</span> <span class="n">region_height</span> <span class="o">*</span> <span class="n">map_height</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-185'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-185'>#</a>
      </div>
      <p>Post-process a map image to overlay PNG symbols at point coordinates.</p>
<p>Args:
    map_image_path: Path to the generated map image
    region: Region configuration dictionary
    config: Atlas configuration dictionary</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">x_offset</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">png_size</span> <span class="o">//</span> <span class="mi">2</span>
                        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">png_size</span> <span class="o">//</span> <span class="mi">2</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-186'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-186'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="n">x_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> 
                            <span class="n">x_offset</span> <span class="o">+</span> <span class="n">png_size</span> <span class="o">&lt;=</span> <span class="n">map_width</span> <span class="ow">and</span> 
                            <span class="n">y_offset</span> <span class="o">+</span> <span class="n">png_size</span> <span class="o">&lt;=</span> <span class="n">map_height</span><span class="p">):</span>
                            <span class="n">map_img</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">png_symbol</span><span class="p">,</span> <span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">),</span> <span class="n">png_symbol</span><span class="p">)</span>
                            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process points for layer </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-187'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-187'>#</a>
      </div>
      <p>Load the map image</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">map_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">map_image_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG symbols overlaid on map: </span><span class="si">{</span><span class="n">map_image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PIL/Pillow not available. PNG symbols will not be overlaid.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to overlay PNG symbols: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-188'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-188'>#</a>
      </div>
      <p>Get region bounds for coordinate transformation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">build_region_map_grass_png</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-189'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-189'>#</a>
      </div>
      <p>Process each vector layer for PNG symbols</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">grass_init</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">grass.script</span> <span class="k">as</span> <span class="nn">gs</span>
    <span class="kn">import</span> <span class="nn">grass.jupyter</span> <span class="k">as</span> <span class="nn">gj</span>
    
    <span class="k">if</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">9000</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2400</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="n">gj</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">clip_bbox</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;g.region&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span><span class="n">e</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">],</span><span class="n">w</span><span class="o">=</span><span class="n">clip_bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-190'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-190'>#</a>
      </div>
      <p>Check if PNG file exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">raster_name</span> <span class="o">=</span> <span class="s1">&#39;hillshadered_&#39;</span> <span class="o">+</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;making map image for </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.in.gdal&#39;</span><span class="p">,</span>  <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;raster&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="n">raster_name</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.colors&#39;</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="n">raster_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
    
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.mapcalc.simple&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.colors&#39;</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey1.0&#39;</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;r.blend&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">raster_name</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s1">&#39;ones&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;blended&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="s1">&#39;55&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">m</span><span class="o">.</span><span class="n">d_rast</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="s1">&#39;blended&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-191'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-191'>#</a>
      </div>
      <p>Load PNG symbol</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">png_layers</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-192'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-192'>#</a>
      </div>
      <p>Resize PNG to specified size</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">lc</span><span class="p">,</span><span class="n">lp</span> <span class="ow">in</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;vectors&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding region </span><span class="si">{</span><span class="n">lc</span><span class="si">}</span><span class="s2"> to map for region </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="k">for</span> <span class="n">update_key</span><span class="p">,</span> <span class="n">update_value</span> <span class="ow">in</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lc</span><span class="p">[</span><span class="n">update_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_value</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;region config override: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">lc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">gs</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;v.import&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">lp</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-193'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-193'>#</a>
      </div>
      <p>Load point coordinates from GeoJSON</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">lame</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lame</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;layer is empty...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-194'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-194'>#</a>
      </div>
      <p>Convert geographic coordinates to image coordinates
Note: This assumes the map image covers the exact region bounds</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">png_config</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png_symbol&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">png_config</span> <span class="ow">and</span> <span class="n">png_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">):</span>
                <span class="n">png_path</span> <span class="o">=</span> <span class="n">png_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
                <span class="n">png_size</span> <span class="o">=</span> <span class="n">png_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG symbol configured for </span><span class="si">{</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">png_path</span><span class="si">}</span><span class="s2"> (size: </span><span class="si">{</span><span class="n">png_size</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-195'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-195'>#</a>
      </div>
      <p>Calculate position for centered placement</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_labels&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding Points with PNG symbols and labels&quot;</span><span class="p">)</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">icon</span><span class="o">=</span><span class="s1">&#39;basic/circle&#39;</span><span class="p">,</span>  <span class="c1"># Minimal icon</span>
                             <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Very small to be nearly invisible</span>
                             <span class="n">label_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                             <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding Points with PNG symbols (no labels)&quot;</span><span class="p">)</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">icon</span><span class="o">=</span><span class="s1">&#39;basic/circle&#39;</span><span class="p">,</span>  <span class="c1"># Minimal icon</span>
                             <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Very small to be nearly invisible</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-196'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-196'>#</a>
      </div>
      <p>Paste PNG symbol onto map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">png_layers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lc</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">png_config</span><span class="p">))</span>
                
            <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-197'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-197'>#</a>
      </div>
      <p>Save the modified map image</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_labels&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding Points with default symbol and labels&quot;</span><span class="p">)</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">icon</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;basic/diamond&#39;</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                             <span class="n">label_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                             <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding Points with default symbol&quot;</span><span class="p">)</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">icon</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;basic/diamond&#39;</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-198'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-198'>#</a>
      </div>
      <p>Build a region map using GRASS GIS with PNG images for point features instead of icons.</p>
<p>Args:
    config: Atlas configuration dictionary
    outlet_name: Name of the outlet
    region: Region configuration dictionary</p>
<p>Returns:
    Path to the generated map image</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">c</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_color&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;vector_width&#39;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">fill_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fc</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                         <span class="n">width_column</span><span class="o">=</span><span class="s1">&#39;vector_width&#39;</span><span class="p">,</span>
                         <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
                         <span class="n">label_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">d_vect</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">fill_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fc</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                         <span class="n">width</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constant_width&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                         <span class="n">attribute_column</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alterations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
                         <span class="n">label_color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                
    <span class="n">m</span><span class="o">.</span><span class="n">d_grid</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">d_legend_vect</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-199'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-199'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">outpath</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">outlet_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;page_</span><span class="si">{</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-200'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-200'>#</a>
      </div>
      <p>load region layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">png_layers</span><span class="p">:</span>
        <span class="n">_overlay_png_symbols_on_map</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-201'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-201'>#</a>
      </div>
      <p>Track which layers have PNG symbols for post-processing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">outpath</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-202'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-202'>#</a>
      </div>
      <p>add layers to map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_3dview</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-203'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-203'>#</a>
      </div>
      <p>clunky but need to skip empty sets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="kn">import</span> <span class="nn">_3dview</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-204'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-204'>#</a>
      </div>
      <p>Check if PNG configuration exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outlets&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;3dview.html&quot;</span>
    <span class="n">_3dview</span><span class="o">.</span><span class="n">create_3d_terrain_view</span><span class="p">(</span><span class="n">atlas_name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;3D terrain visualization using MapLibre GL JS&#39;</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-205'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-205'>#</a>
      </div>
      <p>For PNG symbols, use minimal/invisible icons so we can overlay PNGs later</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">outlet_notebook_jupyter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-206'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-206'>#</a>
      </div>
      <p>Track this layer for PNG overlay</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-207'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-207'>#</a>
      </div>
      <p>No PNG config, use default icon behavior</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_notebook</span><span class="p">()</span>
    <span class="n">notebook</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;kernelspec&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;python3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Python 3&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-208'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-208'>#</a>
      </div>
      <p>Handle non-point geometries (lines, polygons) the same as original</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">config_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;atlas_config.json&quot;</span><span class="p">)</span>

    <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">![atlas](atlas4.png)</span>

<span class="s2">A fire atlas is a configuration convention for geospatial assets related to community fire planning and response together with a configuration for ways to instantiate, edit, and manage those assets.</span>

<span class="s2">A stewardship atlas is a data set, a confuration for storing, processing, and sharing that data set, and a set of implementions to do so.</span>

<span class="s2">This is a minimal notebook intended as a starting point for working with a specific atlas. It comes prebuilt to get started with:</span>
<span class="s2">* generate atlas - bootstrap configuration</span>
<span class="s2">* populate atlas with data</span>
<span class="s2">* materialize some core interfaces to the atlas</span>
<span class="s2">  * web map</span>
<span class="s2">  * web edit</span>
<span class="s2">  * html console</span>
<span class="s2">  * sql query</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>
    
    <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import sys, os, subprocess, time, json, string, datetime, random, math</span>
<span class="s2">sys.path.insert(0, &quot;/root/stewardship_atlas/python&quot;)</span>
<span class="s2">import dataswale_geojson as dataswale</span>
<span class="s2">import deltas_geojson as deltas</span>
<span class="s2">import versioning</span>
<span class="s2">import outlets</span>
<span class="s2">import atlas</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>
    <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;c = json.load(open(&#39;</span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&#39;))&quot;</span><span class="p">))</span>
    <span class="n">notebook</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#DIVIDER</span>
<span class="s2">atlas.materialize(config=c, asset_name=&quot;dem&quot;, delta_queue=deltas)</span>
<span class="s2">dataswale.refresh_raster_layer(c, &#39;elevation&#39;, deltas.apply_deltas)</span>
<span class="s2">atlas.materialize(c, &#39;derived_hillshade&#39;)</span>
<span class="s2">atlas.materialize(c, &#39;gdal_contours&#39;)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">atlas.materialize(c, &#39;public_roads&#39;)</span>
<span class="s2">dataswale.refresh_vector_layer(c, &#39;roads&#39;)</span>
<span class="s2">atlas.materialize(materializers, c, &#39;public_creeks&#39;)</span>
<span class="s2">dataswale.refresh_vector_layer(c, &#39;creeks&#39;, deltas.apply_deltas)</span>

<span class="s2">atlas.materialize(config=c, name=&quot;public_buildings&quot;, delta_queue=deltas)</span>
<span class="s2">dataswale.refresh_vector_layer(c, &#39;buildings&#39;, deltas.apply_deltas)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">outlets.outlet_html(c, &#39;html&#39;)</span>
<span class="s2">atlas.materialize(c, &#39;webmap&#39;)</span>
<span class="s2">atlas.materialize(c, &#39;webedit&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>

    
    <span class="n">nb_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outlet_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nb_name</span><span class="si">}</span><span class="s1">.ipynb&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notebook</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-209'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-209'>#</a>
      </div>
      <p>export map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">gsheet_export</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">outlet_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-210'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-210'>#</a>
      </div>
      <p>Post-process to overlay PNG symbols if any were configured</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-211'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-211'>#</a>
      </div>
      <p>return path to map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">statefile_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;state.json&quot;</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">service_account</span><span class="p">()</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-212'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-212'>#</a>
      </div>
      <p>Generate a 3D terrain view using MapLibre GL JS.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="n">outlet_name</span><span class="p">][</span><span class="s1">&#39;in_layers&#39;</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-213'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-213'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">layer</span> <span class="o">=</span> <span class="n">dataswale_geojson</span><span class="o">.</span><span class="n">layer_as_featurecollection</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">)</span>
        <span class="n">gsheet_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Fire Atlas: </span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">)</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="s1">&#39;gateless@gmail.com&#39;</span><span class="p">,</span> <span class="n">perm_type</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;writer&#39;</span><span class="p">)</span>

        <span class="n">sh</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">wks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">get_worksheet</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-214'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-214'>#</a>
      </div>
      <p>Generate the 3D terrain HTML file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gspread</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-215'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-215'>#</a>
      </div>
      <p>Generate a Jupyter notebook for the outlet.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gspread</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gspread</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">geojson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]))</span> <span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">update_cells</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">links</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span>  <span class="n">sh</span><span class="o">.</span><span class="n">url</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-216'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-216'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-217'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-217'>#</a>
      </div>
      <p>Create a new Jupyter notebook</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-218'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-218'>#</a>
      </div>
      <p>Add python cells directly - would be cool load them from outlet config</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">config_path</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">atlas_path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;atlas_config.json&quot;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;spreadsheets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">links</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-219'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-219'>#</a>
      </div>
      <p>Core elevation derived layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>
                  
        <span class="k">return</span> <span class="n">statefile_path</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-220'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-220'>#</a>
      </div>
      <p>Core vector lyaers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-221'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-221'>#</a>
      </div>
      <p>Outlets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-222'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-222'>#</a>
      </div>
      <p>Create a Google Sheet layer from an atlas layer.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-223'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-223'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-224'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-224'>#</a>
      </div>
      <p>set up spreadsheet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-225'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-225'>#</a>
      </div>
      <p>get layers in outlet config</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-226'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-226'>#</a>
      </div>
      <p>get path to layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-227'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-227'>#</a>
      </div>
      <p>logger.info(f&rdquo;Adding row for Prop [{type(f[&lsquo;properties&rsquo;])}]: {f[&lsquo;properties&rsquo;]} and geom [{type(f[&lsquo;properties&rsquo;])}]:: {f[&lsquo;geometry&rsquo;]}&hellip;&rdquo;)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-228'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-228'>#</a>
      </div>
      <p>wks.update_cell(i+1, j+1, p[0])
wks.update_cell(i+2, j+1, p[1])</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-229'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-229'>#</a>
      </div>
      <p>sh.close()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-230'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-230'>#</a>
      </div>
      <p>state = json.load(open(statefile_path))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-231'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-231'>#</a>
      </div>
      <p>Set and write state to reflect generated spreadsheets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-232'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-232'>#</a>
      </div>
      <p>json.dump(state, open(statefile_path, &ldquo;w&rdquo;))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
